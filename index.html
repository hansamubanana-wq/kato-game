<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATH CLASS: ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111;
            --accent-color: #80ff80;
            --danger-color: #ff4040;
            --text-color: #eee;
            --twitter-color: #1da1f2;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            image-rendering: pixelated;
        }

        /* 走査線エフェクト */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
        }

        .screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* ゲーム画面 */
        #game-screen { justify-content: flex-start; }
        #teacher-area {
            height: 45vh; width: 100%; border-bottom: 4px solid var(--accent-color);
            background: #222; position: relative; display: flex;
            justify-content: center; align-items: flex-end; padding-bottom: 20px;
        }
        #player-area {
            height: 55vh; width: 100%; background-color: #333; position: relative;
            display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; padding-top: 30px; border-top: 4px solid #000;
        }

        /* スプライト共通 */
        .sprite {
            width: 120px; height: 120px;
            background-repeat: no-repeat; background-position: center; background-size: contain;
        }

        /* ▼▼ SVGデータ (先生) ▼▼ */
        .teacher-writing { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .teacher-peeking { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .teacher-angry { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23ffcccc'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='4' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='4' width='3' height='1' fill='%23a00'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }

        /* ▼▼ SVGデータ (生徒スキン) ▼▼ */
        /* Skin 0: 普通 */
        .skin0-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E"); }
        .skin0-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='3' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='7' width='6' height='3' fill='%234488ff'/%3E%3C/svg%3E"); }
        
        /* Skin 1: ヤンキー (金髪・赤服) */
        .skin1-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='1' width='6' height='2' fill='%23ee0'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%23d00'/%3E%3C/svg%3E"); }
        .skin1-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='3' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='2' width='6' height='2' fill='%23ee0'/%3E%3Crect x='3' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='7' width='6' height='3' fill='%23d00'/%3E%3C/svg%3E"); }

        /* Skin 2: 布団 (最強) */
        .skin2-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%23fff'/%3E%3C/svg%3E"); }
        .skin2-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23eee'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%23aaf'/%3E%3Crect x='3' y='4' width='4' height='2' fill='%23f0c0a0'/%3E%3C/svg%3E"); }

        /* バレた時共通（青ざめ） */
        .student-busted {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23aaccff'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='5' width='3' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E");
            animation: shake 0.2s infinite;
        }

        /* UI類 */
        #score-board { font-size: 20px; margin: 10px; color: var(--accent-color); }
        .btn {
            font-family: 'Press Start 2P', cursive;
            background: var(--accent-color); border: 4px solid #000;
            padding: 10px 15px; font-size: 14px; color: #000; cursor: pointer; margin: 10px;
        }
        .btn:active { transform: translate(4px, 4px); }
        .btn-tweet { background: var(--twitter-color); color: white; border-color: white; }
        
        #shop-btn { position: absolute; top: 10px; right: 10px; font-size: 10px; background: #ffcc00; }
        #total-points { font-size: 10px; color: #ffcc00; margin-top: 10px; }

        /* ショップ画面 */
        #shop-screen { background: #000; z-index: 100; }
        .shop-item { border: 2px solid #555; padding: 10px; margin: 10px; width: 80%; display: flex; align-items: center; justify-content: space-between; }
        .shop-item.unlocked { border-color: var(--accent-color); color: var(--accent-color); }
        .shop-item.locked { opacity: 0.5; }

        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
        .zzz { position: absolute; color: var(--accent-color); font-size: 20px; animation: floatUp 1.5s steps(4) forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }

    </style>
</head>
<body>

    <div id="title-screen" class="screen">
        <button id="shop-btn" class="btn" onclick="openShop()">SHOP</button>
        <h1>MATH CLASS<br>ULTIMATE</h1>
        <div style="display: flex; gap: 20px; margin: 30px;">
             <div id="title-student" class="sprite" style="width:80px; height:80px;"></div>
             <div style="font-size:20px; align-self:center;">VS</div>
             <div class="sprite teacher-angry" style="width:80px; height:80px;"></div>
        </div>
        <p class="blink" style="font-size: 12px; margin-top: 20px; color: var(--danger-color);">PRESS START</p>
        <button class="btn" onclick="startGame()">GAME START</button>
        <div id="total-points">TOTAL SLEEP: 0s</div>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h2 style="color:#ffcc00;">SKIN SHOP</h2>
        <div id="shop-list"></div>
        <button class="btn" onclick="closeShop()">BACK</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="teacher-area"><div id="teacher-sprite" class="sprite teacher-writing"></div></div>
        <div id="player-area">
            <div id="student-sprite" class="sprite"></div>
            <div id="score-board">SCORE: 0.0</div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden" style="background: #500;">
        <h1 style="color: #fff;">!! BUSTED !!</h1>
        <div style="display: flex; gap: 20px; justify-content: center;">
            <div class="sprite student-busted"></div>
            <div class="sprite teacher-angry"></div>
        </div>
        <div style="font-size: 32px; margin: 20px 0; color: var(--accent-color);" id="final-score">SCORE: 0.0</div>
        
        <button class="btn btn-tweet" onclick="tweetScore()">Post to X</button>
        <button class="btn" onclick="location.reload()">RETRY</button>
    </div>

    <script>
        // --- 1. オーディオシステム (Retro Sound) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'select') { // ピコッ
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'dead') { // ブブー
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'alert') { // 先生が気づいた音
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }
        }

        // --- 2. データ管理 & スキンシステム ---
        let totalSleep = parseFloat(localStorage.getItem("katoTotalSleep")) || 0;
        let currentSkin = parseInt(localStorage.getItem("katoCurrentSkin")) || 0;
        
        // スキン定義
        const skins = [
            { id: 0, name: "Student", cost: 0, desc: "Default" },
            { id: 1, name: "Yankee", cost: 100, desc: "Gold Hair" },
            { id: 2, name: "Futon", cost: 500, desc: "Pro Sleeper" }
        ];

        function saveGame() {
            localStorage.setItem("katoTotalSleep", totalSleep);
            localStorage.setItem("katoCurrentSkin", currentSkin);
            updateUI();
        }

        // --- ゲームロジック ---
        const titleScreen = document.getElementById("title-screen");
        const gameScreen = document.getElementById("game-screen");
        const resultScreen = document.getElementById("result-screen");
        const shopScreen = document.getElementById("shop-screen");
        
        const teacherSprite = document.getElementById("teacher-sprite");
        const studentSprite = document.getElementById("student-sprite");
        const titleStudent = document.getElementById("title-student");
        const scoreEl = document.getElementById("score-board");
        const totalPointsEl = document.getElementById("total-points");

        let isSleeping = false;
        let isTeacherLooking = false;
        let score = 0;
        let gameOver = false;
        let zzzInterval;

        // 初期化
        updateUI();

        function updateUI() {
            totalPointsEl.textContent = "TOTAL SLEEP POINTS: " + totalSleep.toFixed(1);
            // スキン適用
            titleStudent.className = `sprite skin${currentSkin}-awake`;
            studentSprite.className = `sprite skin${currentSkin}-awake`;
        }

        function startGame() {
            initAudio(); // 音の許可
            playSound('select');
            titleScreen.classList.add("hidden");
            gameScreen.classList.remove("hidden");
            updateTeacher();
            gameLoop();
        }

        function updateTeacher() {
            if (gameOver) return;
            teacherSprite.className = "sprite teacher-writing";

            let difficulty = Math.max(800, 4000 - (score * 5)); 
            setTimeout(() => {
                teacherSprite.className = "sprite teacher-peeking";
                setTimeout(() => {
                    teacherSprite.className = "sprite teacher-angry";
                    isTeacherLooking = true;
                    playSound('alert');

                    // 振動（バイブレーション）
                    if (navigator.vibrate) navigator.vibrate(50);

                    setTimeout(() => {
                        if(!gameOver) {
                            isTeacherLooking = false;
                            updateTeacher();
                        }
                    }, Math.random() * 1500 + 500);
                }, 800); 
            }, Math.random() * difficulty + 1000);
        }

        function gameLoop() {
            setInterval(() => {
                if (gameOver) return;
                if (isSleeping) {
                    score++;
                    scoreEl.textContent = "SCORE: " + (score / 10).toFixed(1);
                    if (isTeacherLooking) endGame();
                }
            }, 100);
        }

        function endGame() {
            gameOver = true;
            playSound('dead');
            
            // 振動（長め）
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // ポイント加算
            totalSleep += (score / 10);
            saveGame();

            studentSprite.className = "sprite student-busted";
            setTimeout(() => {
                gameScreen.classList.add("hidden");
                resultScreen.classList.remove("hidden");
                document.getElementById("final-score").textContent = "SCORE: " + (score / 10).toFixed(1);
            }, 1000);
        }

        // --- 操作系 ---
        const startSleep = () => {
            if (!gameOver) {
                isSleeping = true;
                studentSprite.className = `sprite skin${currentSkin}-sleep`;
                if (!zzzInterval) zzzInterval = setInterval(spawnZzz, 400);
            }
        };

        const stopSleep = () => {
            if (!gameOver) {
                isSleeping = false;
                studentSprite.className = `sprite skin${currentSkin}-awake`;
                if (zzzInterval) { clearInterval(zzzInterval); zzzInterval = null; }
            }
        };

        function spawnZzz() {
            const zzz = document.createElement("div");
            zzz.className = "zzz"; zzz.textContent = "z";
            zzz.style.left = "50%"; zzz.style.top = "0px";
            document.getElementById("player-area").appendChild(zzz);
            setTimeout(() => zzz.remove(), 1500);
        }

        // 入力イベント
        const touchLayer = document.getElementById("player-area");
        touchLayer.addEventListener("touchstart", (e) => { e.preventDefault(); startSleep(); });
        touchLayer.addEventListener("touchend", (e) => { e.preventDefault(); stopSleep(); });
        document.addEventListener("keydown", (e) => { if (e.code === "Space") startSleep(); });
        document.addEventListener("keyup", (e) => { if (e.code === "Space") stopSleep(); });

        // --- 3. ショップシステム ---
        function openShop() {
            playSound('select');
            shopScreen.classList.remove("hidden");
            const list = document.getElementById("shop-list");
            list.innerHTML = ""; // リセット

            skins.forEach(skin => {
                const div = document.createElement("div");
                const isUnlocked = totalSleep >= skin.cost;
                const isSelected = currentSkin === skin.id;
                
                div.className = `shop-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                div.style.background = isSelected ? "#333" : "transparent";
                
                div.innerHTML = `
                    <div style="text-align:left;">
                        <div>${skin.name}</div>
                        <div style="font-size:10px;">Cost: ${skin.cost}s</div>
                    </div>
                    <div>${isSelected ? "EQUIPPED" : (isUnlocked ? "SELECT" : "LOCKED")}</div>
                `;

                div.onclick = () => {
                    if (isUnlocked) {
                        currentSkin = skin.id;
                        playSound('select');
                        saveGame();
                        openShop(); // 再描画
                    }
                };
                list.appendChild(div);
            });
        }
        function closeShop() { playSound('select'); shopScreen.classList.add("hidden"); }

        // --- 4. SNSシェア機能 ---
        function tweetScore() {
            const text = `激闘！加藤先生の授業で ${ (score/10).toFixed(1) }秒 寝ました！`;
            const url = "https://kato-game-soichi.onrender.com"; // ※自分のURLに変えてもOK
            const hashtags = "加藤先生ゲーム,居眠りチャレンジ";
            const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=${encodeURIComponent(hashtags)}`;
            window.open(tweetUrl, '_blank');
        }

    </script>
</body>
</html>