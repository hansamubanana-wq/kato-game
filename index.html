<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­</title>
    <meta name="description" content="å…ˆç”Ÿã«ãƒãƒ¬ãšã«å¯ã‚ï¼ã‚¹ãƒªãƒ«æº€ç‚¹ã®æˆæ¥­ä¸­ã‚µãƒã‚¤ãƒãƒ«ã‚²ãƒ¼ãƒ ã€‚">
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta property="og:title" content="æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­">
    <meta property="og:type" content="website">
    <meta property="og:description" content="å…ˆç”Ÿã®ç›®ã‚’ç›—ã‚“ã§å±…çœ ã‚Šã—ã‚ï¼ã‚¹ãƒãƒ›ã§éŠã¹ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã€‚">
    <meta property="og:url" content="https://kato-game-1.onrender.com">
    <meta property="og:image" content="https://kato-game-1.onrender.com/icon.png">
    <meta name="twitter:card" content="summary_large_image">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=New+Tegomin&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #202020; --accent-color: #ffd700; --danger-color: #ff4444; --text-color: #eee; }
        body { font-family: 'Press Start 2P', cursive; text-align: center; background-color: var(--bg-color); color: var(--text-color); margin: 0; overflow: hidden; touch-action: manipulation; user-select: none; image-rendering: pixelated; }
        body::after { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%); background-size: 100% 4px; pointer-events: none; z-index: 999; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); transition: opacity 0.3s; }
        .hidden { display: none !important; }
        
        .btn { font-family: 'Press Start 2P', cursive; background: #444; border: 4px solid #fff; padding: 15px; font-size: 14px; color: #fff; cursor: pointer; margin: 5px; width: 80%; }
        .btn:active { transform: translateY(4px); } 
        .btn.cleared { border-color: var(--accent-color); color: var(--accent-color); background: #333; } 
        .btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; }
        .btn-endless { border-color: #ff00ff; color: #ff00ff; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); } }
        .btn-shop { background: #ff9800; border-color: #fff; margin-bottom: 20px; }
        .btn-x { background: #000; border-color: #fff; }
        .btn-line { background: #06c755; border-color: #fff; }
        .btn-share { background: #555; border-color: #ccc; }
        .share-container { display: flex; gap: 5px; width: 85%; justify-content: center; margin-top: 10px; }
        .share-container .btn { width: 100%; font-size: 10px; padding: 10px 5px; }

        #game-screen {
            justify-content: flex-start;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23333'/%3E%3Crect y='160' width='320' height='80' fill='%235a3a22'/%3E%3Crect x='20' y='40' width='60' height='80' fill='%2387ceeb' stroke='%23555' stroke-width='4'/%3E%3Cline x1='50' y1='40' x2='50' y2='120' stroke='%23555' stroke-width='2'/%3E%3Cline x1='20' y1='80' x2='80' y2='80' stroke='%23555' stroke-width='2'/%3E%3Crect x='240' y='50' width='60' height='40' fill='%23eee' stroke='%23ccc' stroke-width='2'/%3E%3Crect x='100' y='140' width='50' height='30' fill='%238b4513'/%3E%3Crect x='110' y='170' width='30' height='10' fill='%236b3e1e'/%3E%3Crect x='200' y='140' width='50' height='30' fill='%238b4513'/%3E%3Crect x='210' y='170' width='30' height='10' fill='%236b3e1e'/%3E%3C/svg%3E");
            background-size: cover; background-position: center;
        }
        #teacher-area { height: 45vh; width: 100%; background: rgba(0,0,0,0.2); position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; }
        #player-area { height: 55vh; width: 100%; background: rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-top: 4px solid #5a3a22; }

        #blackboard-text { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 10px; color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.5); padding: 5px; }
        #hud { width: 90%; display: flex; justify-content: space-between; margin-bottom: 10px; }
        #hearts { color: var(--danger-color); font-size: 20px; text-shadow: 2px 2px 0 #000; }
        #progress-bar { width: 100%; height: 10px; background: #555; margin-top: 10px; border: 2px solid #fff; }
        #progress-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.2s; }
        .sprite { width: 140px; height: 140px; background-repeat: no-repeat; background-position: center; background-size: contain; }
        
        .chalk-missile {
            position: absolute; width: 20px; height: 6px; background: white; border-radius: 2px;
            top: 40%; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 5px rgba(255,255,255,0.8); z-index: 100; animation: flyChalk 0.3s linear forwards;
        }
        @keyframes flyChalk { 0% { top: 40%; transform: translateX(-50%) scale(1); } 100% { top: 80%; transform: translateX(-50%) scale(2) rotate(360deg); } }

        .kato-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23222'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .kato-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23ffcccc'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='4' width='3' height='1' fill='%23a00'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .matsuda-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='1' width='6' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='1' width='6' height='2' fill='%23622'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23d8bfd8'/%3E%3C/svg%3E"); }
        .matsuda-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='1' width='6' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='1' width='6' height='1' fill='%23622'/%3E%3Crect x='8' y='2' width='1' height='4' fill='%23622'/%3E%3Crect x='1' y='2' width='1' height='4' fill='%23622'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='3' width='1' height='1' fill='%23f0a'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23f0a'/%3E%3Crect x='4' y='4' width='2' height='1' fill='%23f00'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23d8bfd8'/%3E%3C/svg%3E"); }
        .sugawara-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='0' width='6' height='3' fill='%23321'/%3E%3Crect x='2' y='2' width='6' height='3' fill='%23e0b090'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23456'/%3E%3C/svg%3E"); }
        .sugawara-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='0' width='6' height='3' fill='%23321'/%3E%3Crect x='2' y='2' width='6' height='3' fill='%23e0b090'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='3' width='2' height='1' fill='%23000' opacity='0.5'/%3E%3Crect x='6' y='3' width='2' height='1' fill='%23000' opacity='0.5'/%3E%3Crect x='4' y='4' width='2' height='1' fill='%23000'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23456'/%3E%3C/svg%3E"); }
        .fukumorita-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23111'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23111'/%3E%3C/svg%3E"); }
        .fukumorita-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23111'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23000'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23fff'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23fff'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23111'/%3E%3Crect x='4' y='5' width='2' height='2' fill='%23fff'/%3E%3Crect x='4' y='6' width='2' height='1' fill='%23a00'/%3E%3Crect x='6' y='5' width='1' height='1' fill='%23fff'/%3E%3Crect x='7' y='6' width='1' height='1' fill='%23fff'/%3E%3C/svg%3E"); }
        .student-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='3' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='7' width='6' height='3' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-hurt { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23fff'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='5' width='3' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E"); animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
        .zzz { position: absolute; color: cyan; font-size: 20px; animation: floatUp 1.5s steps(4) forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        .god-mode { color: gold !important; text-shadow: 0 0 10px gold !important; }
        
        #ending-screen { background: #111; z-index: 2000; }
        #certificate { width: 90%; background: #fff; color: #000; padding: 20px; border: 10px double #ffd700; font-family: 'New Tegomin', serif; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); animation: popIn 1s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        #shop-screen { background: #111; z-index: 1500; }
        .shop-item { border: 2px solid #555; padding: 10px; margin: 10px; width: 80%; display: flex; align-items: center; justify-content: space-between; font-size: 10px; }
        .shop-item.unlocked { border-color: var(--accent-color); }
        .shop-item.selected { background: #333; box-shadow: 0 0 10px var(--accent-color); }
        .shop-icon { font-size: 20px; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="select-screen" class="screen">
        <h1 id="game-title" style="color:var(--accent-color); cursor:pointer;">TEACHER SELECT</h1>
        <p id="cheat-msg" style="color:gold; font-size:10px; display:none;">GOD MODE ACTIVATED!</p>
        
        <div style="font-size:10px; margin-bottom:10px; color:#aaa;">ZP (Sleep Points): <span id="display-zp">0</span></div>
        <button class="btn btn-shop" onclick="openShop()">è³¼è²·éƒ¨ (SHOP)</button>

        <button id="btn-st1" class="btn" onclick="startStage(1)">æ•°å­¦ï¼šåŠ è—¤å…ˆç”Ÿ</button>
        <button id="btn-st2" class="btn" onclick="startStage(2)" disabled>è‹±èªï¼šæ¾ç”°å…ˆç”Ÿ</button>
        <button id="btn-st3" class="btn" onclick="startStage(3)" disabled>éŸ³æ¥½ï¼šè…åŸå…ˆç”Ÿ</button>
        <button id="btn-st4" class="btn" onclick="startStage(4)" disabled>æ‹…ä»»ï¼šç¦ç››ç”°å…ˆç”Ÿ</button>
        <button id="btn-st5" class="btn btn-endless" onclick="startStage(5)" style="display:none; margin-top:30px;">ğŸ’€ ENDLESS MODE</button>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h2 style="color:#ff9800;">è³¼è²·éƒ¨ (SHOP)</h2>
        <p style="font-size:10px;">ZP: <span id="shop-zp">0</span></p>
        <div id="shop-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <button class="btn" onclick="closeShop()">BACK</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="teacher-area"><div id="blackboard-text"></div><div id="teacher-sprite" class="sprite"></div></div>
        <div id="player-area">
            <div id="hud"><div id="hearts">â¤â¤â¤</div><div style="font-size:12px; color:#aaa;">TARGET: <span id="target-score">30</span>s</div></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div id="student-sprite" class="sprite student-awake"></div>
            
            <div id="equipped-skill-display" style="position:absolute; top:5px; right:5px; font-size:20px;"></div>

            <div style="margin-top:20px; color:#ddd; font-size:12px; text-shadow:1px 1px 0 #000;">HOLD SPACE TO SLEEP</div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h1 id="result-title">FAILED</h1>
        <p id="result-msg">å»Šä¸‹ã«ç«‹ã£ã¦ãªã•ã„ï¼</p>
        <button class="btn" onclick="location.reload()">BACK TO MENU</button>
    </div>

    <div id="ending-screen" class="screen hidden">
        <div id="certificate">
            <h2 style="border-bottom: 2px solid #000; display:inline-block; margin-bottom:20px;">ç¡çœ å’æ¥­è¨¼æ›¸</h2>
            <p>æ®¿</p>
            <p style="font-size:12px; line-height:2;">ã‚ãªãŸã¯åŠ è—¤ãƒ»æ¾ç”°ãƒ»è…åŸ<br>ãã—ã¦ç¦ç››ç”°å…ˆç”Ÿã®ç›®ã‚’ç›—ã¿<br>å…¨ã¦ã®æˆæ¥­ã§çˆ†ç¡ã—ãŸã“ã¨ã‚’<br>ã“ã“ã«è¨¼ã—ã¾ã™ã€‚</p>
            <p style="text-align:right; margin-top:20px;">2025å¹´ ç¡çœ å§”å“¡ä¼š</p>
            <div style="font-size:40px; margin-top:10px;">ğŸ’®</div>
        </div>
        <div class="share-container">
            <button class="btn btn-x" onclick="shareX()">Xã§è‡ªæ…¢</button>
            <button class="btn btn-line" onclick="shareLine()">LINE</button>
            <button class="btn btn-share" onclick="shareNative()">å…±æœ‰/ã‚³ãƒ”ãƒ¼</button>
        </div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">æœ€åˆã‹ã‚‰çœ ã‚‹</button>
    </div>

    <script>
        const GAME_URL = "https://kato-game-1.onrender.com";
        const teachers = {
            1: { name: "kato", label: "Math / Kato", target: 15, speed: 1.0, blackboard: "y = axÂ² + ..." },
            2: { name: "matsuda", label: "English / Matsuda", target: 20, speed: 1.2, blackboard: "Open your textbook..." },
            3: { name: "sugawara", label: "Music / Sugawara", target: 25, speed: 0.8, blackboard: "â™ª ~ â™« ~ â™ª" },
            4: { name: "fukumorita", label: "Boss / Fukumorita", target: 30, speed: 1.5, blackboard: "FUTURE PATH..." },
            5: { name: "endless", label: "Endless", target: 9999, speed: 1.0, blackboard: "SURVIVAL MODE" }
        };
        const teacherNames = ["kato", "matsuda", "sugawara", "fukumorita"];
        let currentStage = 1, unlockedStage = parseInt(localStorage.getItem("soichiGameStage")) || 1;
        
        let zp = parseFloat(localStorage.getItem("soichiZP")) || 0;
        let unlockedSkills = JSON.parse(localStorage.getItem("soichiSkills")) || []; 
        let equippedSkill = localStorage.getItem("soichiEquipped");
        // â˜…ä¿®æ­£ç‚¹ï¼šnullã¨ã„ã†æ–‡å­—åˆ—ãŒä¿å­˜ã•ã‚Œã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
        if (equippedSkill === "null") equippedSkill = null;

        const skills = {
            "speed": { name: "é€Ÿè¨˜ãƒšãƒ³", price: 50, icon: "ğŸ–Šï¸", desc: "ç¡çœ é€Ÿåº¦ 1.5å€" },
            "shield": { name: "é‰„å£ã®æ•™ç§‘æ›¸", price: 100, icon: "ğŸ›¡ï¸", desc: "ãƒ©ã‚¤ãƒ• +1" },
            "stealth": { name: "éš å¯†ã‚¸ãƒ£ãƒ¼ã‚¸", price: 200, icon: "ğŸ•¶ï¸", desc: "å…ˆç”Ÿã®åå¿œé…å»¶" }
        };

        let hp = 3, sleepTime = 0, isSleeping = false, isTeacherLooking = false, isInvincible = false;
        let gameLoopId, teacherTimerId, zzzInterval, isGodMode = false, tapCount = 0, endlessSpeed = 1.0;

        function saveGameData() {
            localStorage.setItem("soichiZP", zp);
            localStorage.setItem("soichiSkills", JSON.stringify(unlockedSkills));
            localStorage.setItem("soichiEquipped", equippedSkill);
        }

        function initMenu() { 
            document.getElementById("display-zp").textContent = Math.floor(zp);
            for(let i=1; i<=4; i++) { const btn = document.getElementById(`btn-st${i}`); if(i <= unlockedStage) { btn.disabled = false; if(i < unlockedStage || unlockedStage >=5) btn.classList.add("cleared"); } } 
            if (unlockedStage >= 5) { document.getElementById("btn-st5").style.display = "block"; } 
        }
        initMenu();

        function openShop() {
            document.getElementById("select-screen").classList.add("hidden");
            document.getElementById("shop-screen").classList.remove("hidden");
            document.getElementById("shop-zp").textContent = Math.floor(zp);
            renderShopList();
        }
        function closeShop() {
            document.getElementById("shop-screen").classList.add("hidden");
            document.getElementById("select-screen").classList.remove("hidden");
            initMenu();
        }
        function renderShopList() {
            const list = document.getElementById("shop-list");
            list.innerHTML = "";
            Object.keys(skills).forEach(key => {
                const s = skills[key];
                const isUnlocked = unlockedSkills.includes(key);
                const isEquipped = equippedSkill === key;
                
                const div = document.createElement("div");
                div.className = `shop-item ${isUnlocked ? 'unlocked' : ''} ${isEquipped ? 'selected' : ''}`;
                
                let btnHtml = "";
                if (isEquipped) {
                    btnHtml = `<button disabled>è£…ç€ä¸­</button>`;
                } else if (isUnlocked) {
                    // â˜…å®‰å…¨å¯¾ç­–ï¼šæ–‡å­—åˆ—ã§æ¸¡ã™
                    btnHtml = `<button onclick="equipSkill('${key}')">è£…å‚™</button>`;
                } else {
                    if (zp >= s.price) {
                        btnHtml = `<button onclick="buySkill('${key}')">è³¼å…¥ ${s.price}ZP</button>`;
                    } else {
                        btnHtml = `<button disabled>ä¸è¶³ ${s.price}ZP</button>`;
                    }
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="shop-icon">${s.icon}</span>
                        <div style="text-align:left;">
                            <div>${s.name}</div>
                            <div style="color:#aaa;">${s.desc}</div>
                        </div>
                    </div>
                    <div>${btnHtml}</div>
                `;
                list.appendChild(div);
            });
            if(equippedSkill) {
                // â˜…å®‰å…¨å¯¾ç­–ï¼šnullã‚’æ¸¡ã™
                const removeDiv = document.createElement("div");
                removeDiv.innerHTML = `<button class="btn" style="width:100%; font-size:10px;" onclick="equipSkill(null)">è£…å‚™ã‚’å¤–ã™</button>`;
                list.appendChild(removeDiv);
            }
        }
        function buySkill(key) {
            if (zp >= skills[key].price) {
                zp -= skills[key].price;
                unlockedSkills.push(key);
                saveGameData();
                document.getElementById("shop-zp").textContent = Math.floor(zp);
                renderShopList();
                alert("è³¼å…¥ã—ã¾ã—ãŸï¼");
            }
        }
        function equipSkill(key) {
            equippedSkill = key;
            saveGameData();
            renderShopList();
        }

        document.getElementById("game-title").addEventListener("click", () => { tapCount++; if(tapCount >= 7 && !isGodMode) { isGodMode = true; document.getElementById("cheat-msg").style.display = "block"; document.getElementById("game-title").classList.add("god-mode"); alert("éš ã—ã‚³ãƒãƒ³ãƒ‰æˆåŠŸï¼ç„¡æ•µãƒ¢ãƒ¼ãƒ‰ONï¼"); } });
        
        function startStage(st) { 
            currentStage = st; 
            hp = (equippedSkill === 'shield') ? 4 : 3;
            
            // â˜…å®‰å…¨å¯¾ç­–ï¼šã‚¹ã‚­ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
            const skillDisplay = document.getElementById("equipped-skill-display");
            if(equippedSkill && skills[equippedSkill]) {
                skillDisplay.textContent = skills[equippedSkill].icon;
            } else {
                skillDisplay.textContent = "";
            }

            sleepTime = 0; isTeacherLooking = false; endlessSpeed = 1.0; 
            document.getElementById("select-screen").classList.add("hidden"); document.getElementById("game-screen").classList.remove("hidden"); 
            const t = teachers[currentStage]; document.getElementById("blackboard-text").textContent = t.blackboard; document.getElementById("target-score").textContent = (st===5) ? "âˆ" : t.target; 
            updateHearts(); updateProgress(); updateTeacherBehavior(); gameLoopId = setInterval(gameLoop, 100); 
        }

        function updateTeacherBehavior() { 
            let tName = teachers[currentStage].name; if (currentStage === 5) { tName = teacherNames[Math.floor(Math.random() * teacherNames.length)]; endlessSpeed += 0.05; } 
            const sprite = document.getElementById("teacher-sprite"); sprite.className = `sprite ${tName}-back`; isTeacherLooking = false; 
            let waitBase = 2000; if (tName === 'sugawara') waitBase = 3000; if (tName === 'fukumorita') waitBase = 1000; 
            if (equippedSkill === 'stealth') waitBase += 1000;
            let speed = (currentStage === 5) ? endlessSpeed : teachers[currentStage].speed; 
            let randomTime = (Math.random() * waitBase + 1000) / speed; 
            teacherTimerId = setTimeout(() => { 
                sprite.className = `sprite ${tName}-face`; isTeacherLooking = true; 
                let lookTime = (currentStage === 5) ? Math.max(400, 1000 - endlessSpeed*100) : 1000; 
                setTimeout(() => { updateTeacherBehavior(); }, lookTime); 
            }, randomTime); 
        }

        function gameLoop() { 
            if (isSleeping) { 
                let speedMultiplier = (equippedSkill === 'speed') ? 1.5 : 1.0;
                let cheatMultiplier = isGodMode ? 5.0 : 1.0;
                let gain = 0.1 * speedMultiplier * cheatMultiplier;
                sleepTime += gain; 
                zp += gain;
                updateProgress(); 
                if (isTeacherLooking && !isInvincible) takeDamage(); 
            } 
        }

        function updateProgress() { 
            if(currentStage === 5) { document.getElementById("progress-bar").style.display = "none"; document.getElementById("target-score").textContent = sleepTime.toFixed(1); } else { const t = teachers[currentStage]; const pct = Math.min(100, (sleepTime / t.target) * 100); document.getElementById("progress-fill").style.width = pct + "%"; if (sleepTime >= t.target) stageClear(); } 
        }
        
        const AudioContext = window.AudioContext || window.webkitAudioContext; let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'dead') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'clear') { osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(880, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
        }

        function takeDamage() { 
            if(isGodMode) return; 
            hp--; updateHearts(); playSound('dead'); isInvincible = true; 
            const chalk = document.createElement("div"); chalk.className = "chalk-missile";
            document.getElementById("game-screen").appendChild(chalk);
            setTimeout(() => chalk.remove(), 300);
            document.getElementById("student-sprite").className = "sprite student-hurt"; 
            document.getElementById("game-screen").style.backgroundColor = "#500"; 
            if(navigator.vibrate) navigator.vibrate(200); 
            setTimeout(() => { document.getElementById("game-screen").style.backgroundColor = "transparent"; isInvincible = false; if(isSleeping) document.getElementById("student-sprite").className = "sprite student-sleep"; else document.getElementById("student-sprite").className = "sprite student-awake"; }, 500); 
            if (hp <= 0) gameOver(); 
        }
        
        function updateHearts() { let h = ""; for(let i=0; i<hp; i++) h += "â¤"; const heartEl = document.getElementById("hearts"); heartEl.textContent = h; if(isGodMode) heartEl.classList.add("god-mode"); }
        function stageClear() { clearInterval(gameLoopId); clearTimeout(teacherTimerId); playSound('clear'); saveGameData(); if (currentStage === 4) { if (unlockedStage < 5) { unlockedStage = 5; localStorage.setItem("soichiGameStage", unlockedStage); } showEnding(); return; } if(currentStage >= unlockedStage) { unlockedStage++; localStorage.setItem("soichiGameStage", unlockedStage); } document.getElementById("game-screen").classList.add("hidden"); document.getElementById("result-screen").classList.remove("hidden"); document.getElementById("result-screen").style.background = "#2b4528"; document.getElementById("result-title").textContent = "STAGE CLEAR!"; document.getElementById("result-title").style.color = "gold"; document.getElementById("result-msg").textContent = "æ¬¡ã®æˆæ¥­ã¸é€²ã¿ã¾ã™"; }
        function gameOver() { clearInterval(gameLoopId); clearTimeout(teacherTimerId); saveGameData(); document.getElementById("game-screen").classList.add("hidden"); document.getElementById("result-screen").classList.remove("hidden"); document.getElementById("result-screen").style.background = "#500"; document.getElementById("result-title").textContent = "GAME OVER"; document.getElementById("result-title").style.color = "red"; let msg = "è£œç¿’æ±ºå®š..."; if (currentStage === 5) msg = `è¨˜éŒ²: ${sleepTime.toFixed(1)}ç§’`; document.getElementById("result-msg").textContent = msg; }
        function showEnding() { document.getElementById("game-screen").classList.add("hidden"); document.getElementById("ending-screen").classList.remove("hidden"); for(let i=0; i<50; i++) { const conf = document.createElement("div"); conf.className = "confetti"; conf.style.left = Math.random() * 100 + "vw"; conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`; conf.style.animationDuration = (Math.random() * 2 + 2) + "s"; document.getElementById("ending-screen").appendChild(conf); } }
        const shareText = "ã€è¨¼æ˜æ›¸ã€‘ç§ã¯åŠ è—¤ãƒ»æ¾ç”°ãƒ»è…åŸãƒ»ç¦ç››ç”°å…ˆç”Ÿã®æˆæ¥­ã‚’å…¨ã¦å¯ã¦éã”ã—ãŸã“ã¨ã‚’è¨¼æ˜ã—ã¾ã™ã€‚ #åŠ è—¤å…ˆç”Ÿã‚²ãƒ¼ãƒ ";
        function shareX() { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(GAME_URL)}`, '_blank'); }
        function shareLine() { const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(GAME_URL)}`; window.open(lineUrl, '_blank'); }
        async function shareNative() { if (navigator.share) { try { await navigator.share({ title: 'æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­', text: shareText, url: GAME_URL, }); } catch (err) { console.log('Share canceled'); } } else { navigator.clipboard.writeText(`${shareText} ${GAME_URL}`); alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"); } }
        const startSleep = () => { isSleeping = true; if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-sleep"; if (!zzzInterval) zzzInterval = setInterval(spawnZzz, 400); };
        const stopSleep = () => { isSleeping = false; if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-awake"; if (zzzInterval) { clearInterval(zzzInterval); zzzInterval = null; } };
        function spawnZzz() { const zzz = document.createElement("div"); zzz.className = "zzz"; zzz.textContent = "z"; zzz.style.left = "50%"; zzz.style.top = "0px"; document.getElementById("player-area").appendChild(zzz); setTimeout(() => zzz.remove(), 1500); }
        const touchLayer = document.getElementById("player-area"); touchLayer.addEventListener("touchstart", (e) => { initAudio(); e.preventDefault(); startSleep(); }); touchLayer.addEventListener("touchend", (e) => { e.preventDefault(); stopSleep(); }); document.addEventListener("keydown", (e) => { if (e.code === "Space") { initAudio(); startSleep(); } }); document.addEventListener("keyup", (e) => { if (e.code === "Space") stopSleep(); });
    </script>
</body>
</html>