<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊøÄÈóòÔºÅÂä†Ëó§ÂÖàÁîü„ÅÆÊéàÊ•≠ RPG</title>
    
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta property="og:title" content="ÊøÄÈóòÔºÅÂä†Ëó§ÂÖàÁîü„ÅÆÊéàÊ•≠ RPG">
    <meta property="og:description" content="ÂÖàÁîü„ÅÆËÉΩÂäõ„ÇíÂ•™„Å£„Å¶ÈÄ≤„ÇÅÔºÅÊñ∞ÊÑüË¶ö„ÉªÂ±ÖÁú†„Çä„Éê„Éà„É´RPG„ÄÇ">
    <meta property="og:image" content="https://kato-game-1.onrender.com/icon.png">
    <meta name="twitter:card" content="summary_large_image">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=New+Tegomin&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #202020; --accent-color: #ffd700; --danger-color: #ff4444; --text-color: #eee; }
        body { font-family: 'Press Start 2P', cursive; text-align: center; background-color: var(--bg-color); color: var(--text-color); margin: 0; overflow: hidden; touch-action: manipulation; user-select: none; image-rendering: pixelated; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); transition: opacity 0.3s; }
        .hidden { display: none !important; }
        
        .btn { font-family: 'Press Start 2P', cursive; background: #444; border: 4px solid #fff; padding: 15px; font-size: 14px; color: #fff; cursor: pointer; margin: 5px; box-shadow: 0 6px 0 #222; border-radius: 4px; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #222; }
        
        /* ‚ñº‚ñº‚ñº „É°„Éã„É•„ÉºÁîªÈù¢Ôºà„É™„Ç¢„É´„Å™Âªä‰∏ãÔºâ ‚ñº‚ñº‚ñº */
        #menu-screen {
            justify-content: flex-start;
            /* SVG„ÅßÊèè„ÅÑ„ÅüÂ••Ë°å„Åç„ÅÆ„ÅÇ„ÇãÂªä‰∏ã */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='480' viewBox='0 0 320 480'%3E%3Crect width='320' height='480' fill='%23222'/%3E%3C!-- Â§©‰∫ï --%3E%3Crect width='320' height='150' fill='%23444'/%3E%3C!-- Â∫ä --%3E%3Crect y='330' width='320' height='150' fill='%238b4513'/%3E%3C!-- Â••„ÅÆÂ£Å --%3E%3Crect x='110' y='150' width='100' height='180' fill='%23666'/%3E%3Crect x='120' y='180' width='80' height='150' fill='%23222'/%3E%3C!-- ÂÅ¥Èù¢„ÅÆÂ£Å --%3E%3Cpath d='M0,0 L110,150 L110,330 L0,480 Z' fill='%23999'/%3E%3Cpath d='M320,0 L210,150 L210,330 L320,480 Z' fill='%23888'/%3E%3C!-- Á™ì„ÇÑ„Éâ„Ç¢„ÅÆÁ∑ö --%3E%3Cline x1='0' y1='100' x2='110' y2='190' stroke='%23555' stroke-width='2'/%3E%3Cline x1='320' y1='100' x2='210' y2='190' stroke='%23555' stroke-width='2'/%3E%3C!-- Â∫ä„ÅÆ„Éë„Éº„ÇπÁ∑ö --%3E%3Cline x1='0' y1='480' x2='160' y2='330' stroke='%236b3e1e' stroke-width='2'/%3E%3Cline x1='320' y1='480' x2='160' y2='330' stroke='%236b3e1e' stroke-width='2'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
        }

        #face-off-area {
            display: flex; justify-content: space-between; align-items: flex-end;
            width: 80%; height: 250px; margin-top: 50px; position: relative; z-index: 5;
        }
        .char-box { display: flex; flex-direction: column; align-items: center; transition: transform 0.5s; }
        .char-label { font-size: 10px; margin-top: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; color: #fff; }
        
        .walk-right { animation: walkOff 1.5s forwards linear; }
        .fade-in-right { animation: slideIn 1s forwards ease-out; }
        @keyframes walkOff { 0% { transform: translateX(0); } 20% { transform: translateX(0) translateY(-10px); } 40% { transform: translateX(50px) translateY(0); } 60% { transform: translateX(100px) translateY(-10px); } 100% { transform: translateX(400px) translateY(0); } }
        @keyframes slideIn { 0% { transform: translateX(200px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }

        /* Ë£ÖÂÇô„É°„Éã„É•„Éº */
        #equip-menu {
            width: 90%; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 2px solid #fff;
            display: flex; flex-direction: column; align-items: center; margin-top: auto; margin-bottom: 20px; z-index: 10;
        }
        #current-equip { color: #ffd700; font-size: 10px; margin-bottom: 5px; }
        .equip-list { display: flex; gap: 10px; justify-content: center; min-height: 40px; }
        .equip-item { 
            width: 40px; height: 40px; border: 2px solid #555; background: #333; 
            display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;
        }
        .equip-item.unlocked { border-color: #fff; }
        .equip-item.selected { border-color: #ffd700; box-shadow: 0 0 15px #ffd700; background: #444; }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        #game-screen {
            justify-content: flex-start;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23333'/%3E%3Crect y='160' width='320' height='80' fill='%235a3a22'/%3E%3Crect x='20' y='40' width='60' height='80' fill='%2387ceeb' stroke='%23555' stroke-width='4'/%3E%3Cline x1='50' y1='40' x2='50' y2='120' stroke='%23555' stroke-width='2'/%3E%3Cline x1='20' y1='80' x2='80' y2='80' stroke='%23555' stroke-width='2'/%3E%3Crect x='240' y='50' width='60' height='40' fill='%23eee' stroke='%23ccc' stroke-width='2'/%3E%3Crect x='100' y='140' width='50' height='30' fill='%238b4513'/%3E%3Crect x='110' y='170' width='30' height='10' fill='%236b3e1e'/%3E%3Crect x='200' y='140' width='50' height='30' fill='%238b4513'/%3E%3Crect x='210' y='170' width='30' height='10' fill='%236b3e1e'/%3E%3C/svg%3E");
            background-size: cover; background-position: center;
        }
        #teacher-area { height: 45vh; width: 100%; background: rgba(0,0,0,0.2); position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; }
        #player-area { height: 55vh; width: 100%; background: rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-top: 4px solid #5a3a22; }

        #blackboard-text { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 10px; color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.5); padding: 5px; }
        #hud { width: 90%; display: flex; justify-content: space-between; margin-bottom: 10px; }
        #hearts { color: var(--danger-color); font-size: 20px; text-shadow: 2px 2px 0 #000; }
        #progress-bar { width: 100%; height: 10px; background: #555; margin-top: 10px; border: 2px solid #fff; }
        #progress-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.2s; }
        .sprite { width: 140px; height: 140px; background-repeat: no-repeat; background-position: center; background-size: contain; }
        
        #active-skill-btn {
            position: absolute; bottom: 80px; right: 20px;
            width: 70px; height: 70px; border-radius: 50%;
            background: radial-gradient(circle, #ffeb3b, #fbc02d);
            border: 4px solid #fff; box-shadow: 0 0 15px #ffd700;
            display: none; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; z-index: 100; animation: glow 2s infinite;
        }
        #active-skill-btn:active { transform: scale(0.9); }
        #active-skill-btn.cooldown { filter: grayscale(100%); opacity: 0.5; animation: none; pointer-events: none; }
        @keyframes glow { 0%,100%{box-shadow: 0 0 10px #ffd700;} 50%{box-shadow: 0 0 25px #ffd700;} }

        #config-btn { position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; background: none; border: none; z-index: 20; }
        #exit-btn { position: absolute; top: 10px; left: 10px; font-size: 12px; cursor: pointer; background: #444; color: #fff; border: 2px solid #fff; padding: 5px; z-index: 20; }
        
        #config-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .config-box { background: #333; padding: 20px; border: 2px solid #fff; text-align: center; }

        .chalk-missile {
            position: absolute; width: 20px; height: 6px; background: white; border-radius: 2px;
            top: 40%; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 5px rgba(255,255,255,0.8); z-index: 100; animation: flyChalk 0.3s linear forwards;
        }
        @keyframes flyChalk { 0% { top: 40%; transform: translateX(-50%) scale(1); } 100% { top: 80%; transform: translateX(-50%) scale(2) rotate(360deg); } }

        /* SVG */
        .kato-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23222'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .kato-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23ffcccc'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='4' width='3' height='1' fill='%23a00'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E"); }
        .matsuda-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='1' width='6' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='1' width='6' height='2' fill='%23622'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23d8bfd8'/%3E%3C/svg%3E"); }
        .matsuda-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='1' width='6' height='4' fill='%23f0c0a0'/%3E%3Crect x='2' y='1' width='6' height='1' fill='%23622'/%3E%3Crect x='8' y='2' width='1' height='4' fill='%23622'/%3E%3Crect x='1' y='2' width='1' height='4' fill='%23622'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='3' width='1' height='1' fill='%23f0a'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23f0a'/%3E%3Crect x='4' y='4' width='2' height='1' fill='%23f00'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23d8bfd8'/%3E%3C/svg%3E"); }
        .sugawara-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='0' width='6' height='3' fill='%23321'/%3E%3Crect x='2' y='2' width='6' height='3' fill='%23e0b090'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23456'/%3E%3C/svg%3E"); }
        .sugawara-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='2' y='0' width='6' height='3' fill='%23321'/%3E%3Crect x='2' y='2' width='6' height='3' fill='%23e0b090'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='3' width='2' height='1' fill='%23000' opacity='0.5'/%3E%3Crect x='6' y='3' width='2' height='1' fill='%23000' opacity='0.5'/%3E%3Crect x='4' y='4' width='2' height='1' fill='%23000'/%3E%3Crect x='1' y='5' width='8' height='5' fill='%23456'/%3E%3C/svg%3E"); }
        .fukumorita-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23111'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23111'/%3E%3C/svg%3E"); }
        .fukumorita-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23111'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23000'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23fff'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23fff'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23111'/%3E%3Crect x='4' y='5' width='2' height='2' fill='%23fff'/%3E%3Crect x='4' y='6' width='2' height='1' fill='%23a00'/%3E%3Crect x='6' y='5' width='1' height='1' fill='%23fff'/%3E%3Crect x='7' y='6' width='1' height='1' fill='%23fff'/%3E%3C/svg%3E"); }
        .student-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='3' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='7' width='6' height='3' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-hurt { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23fff'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='5' width='3' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E"); animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
        .zzz { position: absolute; color: cyan; font-size: 20px; animation: floatUp 1.5s steps(4) forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        .god-mode { color: gold !important; text-shadow: 0 0 10px gold !important; }
        
        #ending-screen { background: #111; z-index: 2000; }
        #certificate { width: 90%; background: #fff; color: #000; padding: 20px; border: 10px double #ffd700; font-family: 'New Tegomin', serif; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); animation: popIn 1s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        .btn-x { background: #000; border-color: #fff; }
        .btn-line { background: #06c755; border-color: #fff; }
        .btn-share { background: #555; border-color: #ccc; }
    </style>
</head>
<body>
    <div id="menu-screen" class="screen">
        <h1 id="game-title" style="color:#fff; font-size:16px; margin-top:20px; text-shadow:2px 2px 0 #000; background:rgba(0,0,0,0.5); padding:5px; z-index:10; cursor:pointer;">BATTLE SELECT</h1>
        <button id="config-btn" onclick="openConfig()">‚öôÔ∏è</button>
        <p id="cheat-msg" style="color:gold; font-size:10px; display:none; z-index:10;">GOD MODE!</p>

        <div id="face-off-area">
            <div id="menu-player" class="char-box"><div class="sprite student-awake"></div><div class="char-label">YOU</div></div>
            <div style="font-size:30px; color:var(--danger-color); font-weight:bold; text-shadow:2px 2px 0 #000;">VS</div>
            <div id="menu-rival" class="char-box"><div id="menu-rival-sprite" class="sprite"></div><div id="menu-rival-name" class="char-label">???</div></div>
        </div>

        <button id="start-btn" class="btn" style="width:200px; font-size:16px; background:var(--danger-color);" onclick="startBattle()">BATTLE START</button>

        <div id="equip-menu">
            <div id="current-equip">Ë£ÖÂÇô„Å™„Åó</div>
            <div class="equip-list">
                <div id="skill-kato" class="equip-item" onclick="equipSkill('kato')">‚è±Ô∏è</div>
                <div id="skill-matsuda" class="equip-item" onclick="equipSkill('matsuda')">‚ù§Ô∏è</div>
                <div id="skill-sugawara" class="equip-item" onclick="equipSkill('sugawara')">üéµ</div>
                <div id="skill-fukumorita" class="equip-item" onclick="equipSkill('fukumorita')">üëü</div>
            </div>
            <div style="font-size:8px; margin-top:5px; color:#aaa;">TAP ICON TO EQUIP</div>
        </div>
    </div>

    <div id="config-modal">
        <div class="config-box">
            <h2 style="color:var(--accent-color);">SETTINGS</h2>
            <p style="font-size:10px; color:#aaa;">„ÇØ„É™„Ç¢ÊÉÖÂ†±„ÇíÊìç‰Ωú„Åó„Åæ„Åô</p>
            <button id="ng-plus-btn" class="btn" style="display:none;" onclick="newGamePlus()">üí™ Âº∑„Åè„Å¶„Éã„É•„Éº„Ç≤„Éº„É†<br><span style="font-size:8px">(ËÉΩÂäõÁ∂≠ÊåÅ„Éª„Çπ„ÉÜ„Éº„Ç∏1„Å∏)</span></button>
            <button class="btn" style="border-color:red; color:red;" onclick="hardReset()">üóëÔ∏è ÂÆåÂÖ®ÂàùÊúüÂåñ<br><span style="font-size:8px">(„Éá„Éº„ÇøÂÖ®ÂâäÈô§)</span></button>
            <button class="btn" style="margin-top:20px;" onclick="closeConfig()">CLOSE</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <button id="exit-btn" onclick="exitBattle()">‚Ü© EXIT</button>
        <div id="teacher-area"><div id="blackboard-text"></div><div id="teacher-sprite" class="sprite"></div></div>
        <div id="player-area">
            <div id="hud"><div id="hearts">‚ù§‚ù§‚ù§</div><div style="font-size:12px; color:#aaa;">TARGET: <span id="target-score">30</span>s</div></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div id="student-sprite" class="sprite student-awake"></div>
            <div id="active-skill-btn" onclick="activateKatoSkill()">‚è±Ô∏è</div>
            <div style="margin-top:20px; color:#ddd; font-size:12px; text-shadow:1px 1px 0 #000;">HOLD SPACE TO SLEEP</div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h1 id="result-title">FAILED</h1>
        <p id="result-msg">Âªä‰∏ã„Å´Á´ã„Å£„Å¶„Å™„Åï„ÅÑÔºÅ</p>
        <button class="btn" onclick="returnToMenu()">NEXT</button>
    </div>

    <div id="ending-screen" class="screen hidden">
        <div id="certificate">
            <h2 style="border-bottom: 2px solid #000; display:inline-block; margin-bottom:20px;">Áù°Áú†ÂçíÊ•≠Ë®ºÊõ∏</h2>
            <p>ÊÆø</p>
            <p style="font-size:12px; line-height:2;">„ÅÇ„Å™„Åü„ÅØÂÖ®„Å¶„ÅÆÂÖàÁîü„ÅÆÁõÆ„ÇíÁõó„Åø<br>ËÉΩÂäõ„Çí‰Ωø„ÅÑ„Åì„Å™„Åó<br>ÁàÜÁù°„Åó„Åü„Åì„Å®„ÇíË®º„Åó„Åæ„Åô„ÄÇ</p>
            <p style="text-align:right; margin-top:20px;">2025Âπ¥ Áù°Áú†ÂßîÂì°‰ºö</p>
            <div style="font-size:40px; margin-top:10px;">üíÆ</div>
        </div>
        <div class="share-container">
            <button class="btn btn-x" onclick="shareX()">X„ÅßËá™ÊÖ¢</button>
            <button class="btn btn-line" onclick="shareLine()">LINE</button>
            <button class="btn btn-share" onclick="shareNative()">ÂÖ±Êúâ/„Ç≥„Éî„Éº</button>
        </div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ÊúÄÂàù„Åã„ÇâÁú†„Çã</button>
    </div>

    <script>
        const GAME_URL = "https://kato-game-1.onrender.com";
        const teachers = {
            1: { name: "kato", label: "Math / Kato", target: 15, speed: 1.0, blackboard: "y = ax¬≤ + ...", face:"kato-face" },
            2: { name: "matsuda", label: "English / Matsuda", target: 20, speed: 1.2, blackboard: "Open your textbook...", face:"matsuda-face" },
            3: { name: "sugawara", label: "Music / Sugawara", target: 25, speed: 0.8, blackboard: "‚ô™ ~ ‚ô´ ~ ‚ô™", face:"sugawara-face" },
            4: { name: "fukumorita", label: "Boss / Fukumorita", target: 30, speed: 1.5, blackboard: "FUTURE PATH...", face:"fukumorita-face" },
            5: { name: "endless", label: "ENDLESS SURVIVAL", target: 9999, speed: 1.0, blackboard: "SURVIVAL MODE", face:"fukumorita-face" }
        };
        const teacherNames = ["kato", "matsuda", "sugawara", "fukumorita"];
        
        let unlockedStage = parseInt(localStorage.getItem("soichiGameStage")) || 1;
        let unlockedPowers = JSON.parse(localStorage.getItem("soichiPowers")) || [];
        let equippedPower = localStorage.getItem("soichiEquippedPower");
        if (equippedPower === "null") equippedPower = null;

        let currentStage = unlockedStage > 4 ? 5 : unlockedStage;
        let justCleared = false;
        let hp = 3, sleepTime = 0, isSleeping = false, isTeacherLooking = false, isInvincible = false;
        let gameLoopId, teacherTimerId, zzzInterval, isGodMode = false, tapCount = 0, endlessSpeed = 1.0;
        let isTimeStopped = false, sleepContinuous = 0;

        const AudioContext = window.AudioContext || window.webkitAudioContext; let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'dead') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'clear') { osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(880, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'skill') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.linearRampToValueAtTime(1760, now+0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.5); osc.start(now); osc.stop(now+0.5); }
        }

        function initMenu() {
            currentStage = unlockedStage > 4 ? 5 : unlockedStage;
            updateMenuVisuals(currentStage);
            renderEquipMenu();
        }

        function updateMenuVisuals(stageNum) {
            const t = teachers[stageNum];
            const rivalSprite = document.getElementById("menu-rival-sprite");
            const rivalName = document.getElementById("menu-rival-name");
            rivalSprite.className = "sprite";
            if (stageNum === 5) {
                rivalSprite.textContent = "üíÄ"; rivalSprite.style.fontSize = "50px"; rivalSprite.style.display = "flex"; rivalSprite.style.alignItems = "center"; rivalSprite.style.justifyContent = "center";
                rivalName.textContent = "ENDLESS ZONE";
            } else {
                rivalSprite.textContent = ""; rivalSprite.className = `sprite ${t.face}`; rivalName.textContent = t.label;
            }
        }

        function renderEquipMenu() {
            const skillNames = { "kato": "Âä†Ëó§„ÅÆÊôÇË®à", "matsuda": "ÊùæÁî∞„ÅÆ„É©„É≥„ÉÅ", "sugawara": "ËèÖÂéü„ÅÆ„Çø„ÇØ„Éà", "fukumorita": "Á¶èÁõõÁî∞„ÅÆ„Çπ„Éã„Éº„Ç´„Éº" };
            document.getElementById("current-equip").textContent = equippedPower ? `Ë£ÖÂÇô‰∏≠: ${skillNames[equippedPower]}` : "Ë£ÖÂÇô„Å™„Åó";
            
            // „Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫„ÅÆÂà∂Âæ°ÔºàÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÇÇ„ÅÆ„ÅØÈùûË°®Á§∫Ôºâ
            ["kato", "matsuda", "sugawara", "fukumorita"].forEach(p => {
                const el = document.getElementById(`skill-${p}`);
                if (unlockedPowers.includes(p)) { 
                    el.style.display = "flex"; // ÊåÅ„Å£„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
                    el.classList.add("unlocked"); 
                } else { 
                    el.style.display = "none"; // „Å™„Åë„Çå„Å∞ÈùûË°®Á§∫
                }
                
                if (equippedPower === p) el.classList.add("selected"); 
                else el.classList.remove("selected");
            });
        }

        function equipSkill(power) {
            if (equippedPower === power) equippedPower = null; else equippedPower = power;
            localStorage.setItem("soichiEquippedPower", equippedPower);
            renderEquipMenu();
        }

        /* --- Ë®≠ÂÆö„Éª„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ --- */
        function openConfig() { 
            // Âº∑„Åè„Å¶„Éã„É•„Éº„Ç≤„Éº„É†„Éú„Çø„É≥„ÅÆÂà∂Âæ°
            const ngBtn = document.getElementById("ng-plus-btn");
            // „Çπ„ÉÜ„Éº„Ç∏5Ôºà„Ç®„É≥„Éâ„É¨„ÇπÔºâ„ÅåËß£Êîæ„Åï„Çå„Å¶„ÅÑ„ÇãÔºùÂÖ®„ÇØ„É™Ê∏à„Åø
            if (unlockedStage >= 5) {
                ngBtn.style.display = "block";
            } else {
                ngBtn.style.display = "none";
            }
            document.getElementById("config-modal").style.display = "flex"; 
        }
        function closeConfig() { document.getElementById("config-modal").style.display = "none"; }
        
        function newGamePlus() {
            if(confirm("ËÉΩÂäõ„ÅØ„Åù„ÅÆ„Åæ„Åæ„Åß„ÄÅ„Çπ„ÉÜ„Éº„Ç∏1„Åã„ÇâÂßã„ÇÅ„Åæ„Åô„ÅãÔºü")) {
                localStorage.setItem("soichiGameStage", 1);
                location.reload();
            }
        }
        function hardReset() {
            if(confirm("Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÊ∂à„Åó„Å¶ÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü")) {
                localStorage.clear();
                location.reload();
            }
        }

        document.getElementById("game-title").addEventListener("click", () => { tapCount++; if(tapCount >= 7 && !isGodMode) { isGodMode = true; document.getElementById("cheat-msg").style.display = "block"; document.getElementById("game-title").classList.add("god-mode"); alert("Èö†„Åó„Ç≥„Éû„É≥„ÉâÊàêÂäüÔºÅÁÑ°Êïµ„É¢„Éº„ÉâONÔºÅ"); } });

        function startBattle() {
            initAudio();
            hp = (equippedPower === 'matsuda') ? 4 : 3;
            isTimeStopped = false; sleepContinuous = 0;
            const skillBtn = document.getElementById("active-skill-btn");
            if (equippedPower === 'kato') { skillBtn.style.display = "flex"; skillBtn.classList.remove("cooldown"); } else { skillBtn.style.display = "none"; }
            
            sleepTime = 0; isTeacherLooking = false; endlessSpeed = 1.0;
            document.getElementById("menu-screen").classList.add("hidden");
            document.getElementById("game-screen").classList.remove("hidden");
            
            const t = teachers[currentStage];
            document.getElementById("blackboard-text").textContent = t.blackboard;
            document.getElementById("target-score").textContent = (currentStage===5) ? "‚àû" : t.target;
            
            updateHearts(); updateProgress(); updateTeacherBehavior();
            gameLoopId = setInterval(gameLoop, 100);
        }

        function exitBattle() {
            clearInterval(gameLoopId);
            clearTimeout(teacherTimerId);
            document.getElementById("game-screen").classList.add("hidden");
            document.getElementById("menu-screen").classList.remove("hidden");
            initMenu();
        }

        window.activateKatoSkill = function() {
            const btn = document.getElementById("active-skill-btn");
            if (btn.classList.contains("cooldown")) return;
            playSound('skill'); isTimeStopped = true; btn.classList.add("cooldown");
            isTeacherLooking = false; clearTimeout(teacherTimerId);
            const sprite = document.getElementById("teacher-sprite");
            let tName = (currentStage === 5) ? "kato" : teachers[currentStage].name;
            if(sprite.className.includes("matsuda")) tName = "matsuda";
            if(sprite.className.includes("sugawara")) tName = "sugawara";
            if(sprite.className.includes("fukumorita")) tName = "fukumorita";
            sprite.className = `sprite ${tName}-back`; document.body.style.filter = "invert(1)";
            setTimeout(() => { isTimeStopped = false; document.body.style.filter = "none"; updateTeacherBehavior(); }, 3000);
        };

        function updateTeacherBehavior() {
            if (isTimeStopped) return;
            let tName = teachers[currentStage].name;
            if (currentStage === 5) { tName = teacherNames[Math.floor(Math.random() * teacherNames.length)]; endlessSpeed += 0.05; }
            const sprite = document.getElementById("teacher-sprite"); sprite.className = `sprite ${tName}-back`; isTeacherLooking = false;
            let waitBase = 2000; if (tName === 'sugawara') waitBase = 3000; if (tName === 'fukumorita') waitBase = 1000;
            let speed = (currentStage === 5) ? endlessSpeed : teachers[currentStage].speed;
            let randomTime = (Math.random() * waitBase + 1000) / speed;
            teacherTimerId = setTimeout(() => {
                if (isTimeStopped) return;
                sprite.className = `sprite ${tName}-face`; isTeacherLooking = true;
                let lookTime = (currentStage === 5) ? Math.max(400, 1000 - endlessSpeed*100) : 1000;
                setTimeout(() => { updateTeacherBehavior(); }, lookTime);
            }, randomTime);
        }

        function gameLoop() {
            if (isSleeping) {
                sleepContinuous += 0.1;
                let speedMultiplier = 1.0;
                if (equippedPower === 'sugawara') speedMultiplier = 1.5;
                if (equippedPower === 'fukumorita') { let boost = 1.0 + (sleepContinuous * 0.2); if(boost > 3.0) boost = 3.0; speedMultiplier = boost; }
                let cheatMultiplier = isGodMode ? 5.0 : 1.0;
                sleepTime += 0.1 * speedMultiplier * cheatMultiplier;
                updateProgress();
                if (isTeacherLooking && !isInvincible) takeDamage();
            }
        }

        function updateProgress() { if(currentStage === 5) { document.getElementById("progress-bar").style.display = "none"; document.getElementById("target-score").textContent = sleepTime.toFixed(1); } else { const t = teachers[currentStage]; const pct = Math.min(100, (sleepTime / t.target) * 100); document.getElementById("progress-fill").style.width = pct + "%"; if (sleepTime >= t.target) stageClear(); } }
        
        function takeDamage() {
            if(isGodMode) return;
            hp--; updateHearts(); playSound('dead'); isInvincible = true;
            const chalk = document.createElement("div"); chalk.className = "chalk-missile"; document.getElementById("game-screen").appendChild(chalk); setTimeout(() => chalk.remove(), 300);
            document.getElementById("student-sprite").className = "sprite student-hurt"; document.getElementById("game-screen").style.backgroundColor = "#500"; if(navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => { document.getElementById("game-screen").style.backgroundColor = "transparent"; isInvincible = false; if(isSleeping) document.getElementById("student-sprite").className = "sprite student-sleep"; else document.getElementById("student-sprite").className = "sprite student-awake"; }, 500);
            if (hp <= 0) gameOver();
        }
        function updateHearts() { let h = ""; for(let i=0; i<hp; i++) h += "‚ù§"; const heartEl = document.getElementById("hearts"); heartEl.textContent = h; if(isGodMode) heartEl.classList.add("god-mode"); }

        function stageClear() {
            clearInterval(gameLoopId); clearTimeout(teacherTimerId); playSound('clear');
            let gotPower = false;
            if (currentStage === 1 && !unlockedPowers.includes("kato")) { unlockedPowers.push("kato"); gotPower = true; alert("Âä†Ëó§ÂÖàÁîü„ÅÆ„Å°„Åã„Çâ„ÄåÊáê‰∏≠ÊôÇË®à„Äç„ÇíÂ•™„Å£„ÅüÔºÅ"); }
            if (currentStage === 2 && !unlockedPowers.includes("matsuda")) { unlockedPowers.push("matsuda"); gotPower = true; alert("ÊùæÁî∞ÂÖàÁîü„ÅÆ„Å°„Åã„Çâ„Äå„É©„É≥„ÉÅ„Äç„ÇíÂ•™„Å£„ÅüÔºÅ"); }
            if (currentStage === 3 && !unlockedPowers.includes("sugawara")) { unlockedPowers.push("sugawara"); gotPower = true; alert("ËèÖÂéüÂÖàÁîü„ÅÆ„Å°„Åã„Çâ„Äå„Çø„ÇØ„Éà„Äç„ÇíÂ•™„Å£„ÅüÔºÅ"); }
            if (currentStage === 4 && !unlockedPowers.includes("fukumorita")) { unlockedPowers.push("fukumorita"); gotPower = true; alert("Á¶èÁõõÁî∞ÂÖàÁîü„ÅÆ„Å°„Åã„Çâ„Äå„Çπ„Éã„Éº„Ç´„Éº„Äç„ÇíÂ•™„Å£„ÅüÔºÅ"); }
            localStorage.setItem("soichiPowers", JSON.stringify(unlockedPowers));

            let nextStage = currentStage;
            if (currentStage === 4) {
                if (unlockedStage < 5) { unlockedStage = 5; localStorage.setItem("soichiGameStage", unlockedStage); }
                showEnding(); return;
            } else if(currentStage >= unlockedStage) {
                unlockedStage++; localStorage.setItem("soichiGameStage", unlockedStage);
                nextStage = unlockedStage;
                justCleared = true; 
            }
            document.getElementById("game-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.remove("hidden");
            document.getElementById("result-screen").style.background = "#2b4528";
            document.getElementById("result-title").textContent = "YOU WIN!";
            document.getElementById("result-title").style.color = "gold";
            document.getElementById("result-msg").textContent = gotPower ? "Êñ∞„Åó„ÅÑËÉΩÂäõ„Çí„Ç≤„ÉÉ„ÉàÔºÅ" : "Ê¨°„ÅÆÁõ∏Êâã„Å∏...";
        }

        function returnToMenu() {
            document.getElementById("result-screen").classList.add("hidden");
            document.getElementById("menu-screen").classList.remove("hidden");
            renderEquipMenu();
            if (justCleared && currentStage < 5) { 
                justCleared = false; 
                playWalkAnimation(); 
            } else { 
                initMenu(); 
            }
        }

        function playWalkAnimation() {
            updateMenuVisuals(currentStage); const player = document.getElementById("menu-player"); const rival = document.getElementById("menu-rival");
            rival.style.opacity = "0"; player.classList.add("walk-right");
            setTimeout(() => {
                currentStage = unlockedStage; updateMenuVisuals(currentStage); 
                rival.style.opacity = "1"; rival.classList.add("fade-in-right"); player.classList.remove("walk-right");
                setTimeout(() => { rival.classList.remove("fade-in-right"); }, 1000);
            }, 1500); 
        }

        function gameOver() { clearInterval(gameLoopId); clearTimeout(teacherTimerId); document.getElementById("game-screen").classList.add("hidden"); document.getElementById("result-screen").classList.remove("hidden"); document.getElementById("result-screen").style.background = "#500"; document.getElementById("result-title").textContent = "GAME OVER"; document.getElementById("result-title").style.color = "red"; let msg = "Ë£úÁøíÊ±∫ÂÆö..."; if (currentStage === 5) msg = `Ë®òÈå≤: ${sleepTime.toFixed(1)}Áßí`; document.getElementById("result-msg").textContent = msg; }
        
        function showEnding() { document.getElementById("game-screen").classList.add("hidden"); document.getElementById("ending-screen").classList.remove("hidden"); for(let i=0; i<50; i++) { const conf = document.createElement("div"); conf.className = "confetti"; conf.style.left = Math.random() * 100 + "vw"; conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`; conf.style.animationDuration = (Math.random() * 2 + 2) + "s"; document.getElementById("ending-screen").appendChild(conf); } }
        const shareText = "„ÄêË®ºÊòéÊõ∏„ÄëÁßÅ„ÅØÂä†Ëó§„ÉªÊùæÁî∞„ÉªËèÖÂéü„ÉªÁ¶èÁõõÁî∞ÂÖàÁîü„ÅÆÊéàÊ•≠„ÇíÂÖ®„Å¶ÂØù„Å¶ÈÅé„Åî„Åó„Åü„Åì„Å®„ÇíË®ºÊòé„Åó„Åæ„Åô„ÄÇ #Âä†Ëó§ÂÖàÁîü„Ç≤„Éº„É†";
        function shareX() { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(GAME_URL)}`, '_blank'); }
        function shareLine() { const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(GAME_URL)}`; window.open(lineUrl, '_blank'); }
        async function shareNative() { if (navigator.share) { try { await navigator.share({ title: 'ÊøÄÈóòÔºÅÂä†Ëó§ÂÖàÁîü„ÅÆÊéàÊ•≠', text: shareText, url: GAME_URL, }); } catch (err) { console.log('Share canceled'); } } else { navigator.clipboard.writeText(`${shareText} ${GAME_URL}`); alert("URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ"); } }
        
        const startSleep = () => { isSleeping = true; if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-sleep"; if (!zzzInterval) zzzInterval = setInterval(spawnZzz, 400); };
        const stopSleep = () => { isSleeping = false; sleepContinuous = 0; if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-awake"; if (zzzInterval) { clearInterval(zzzInterval); zzzInterval = null; } };
        function spawnZzz() { const zzz = document.createElement("div"); zzz.className = "zzz"; zzz.textContent = "z"; zzz.style.left = "50%"; zzz.style.top = "0px"; document.getElementById("player-area").appendChild(zzz); setTimeout(() => zzz.remove(), 1500); }
        const touchLayer = document.getElementById("player-area"); touchLayer.addEventListener("touchstart", (e) => { initAudio(); e.preventDefault(); startSleep(); }); touchLayer.addEventListener("touchend", (e) => { e.preventDefault(); stopSleep(); }); document.addEventListener("keydown", (e) => { if (e.code === "Space") { initAudio(); startSleep(); } }); document.addEventListener("keyup", (e) => { if (e.code === "Space") stopSleep(); });

        initMenu();
    </script>
</body>
</html>