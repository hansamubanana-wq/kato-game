<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­ RPG</title>
    
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta property="og:title" content="æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­ RPG">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=New+Tegomin&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #1a1a1a; --accent-color: #ffd700; --danger-color: #ff4444; --text-color: #eee; }
        body { font-family: 'Press Start 2P', cursive; text-align: center; background-color: var(--bg-color); color: var(--text-color); margin: 0; overflow: hidden; touch-action: manipulation; user-select: none; image-rendering: pixelated; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); transition: opacity 0.3s; }
        .hidden { display: none !important; }
        
        .btn { 
            font-family: 'Press Start 2P', cursive; 
            background: linear-gradient(to bottom, #555, #333); 
            border: 2px solid #888; border-bottom: 4px solid #111;
            padding: 15px; font-size: 14px; color: #fff; cursor: pointer; margin: 5px; 
            text-shadow: 1px 1px 0 #000; border-radius: 8px;
        }
        .btn:active { transform: translateY(3px); border-bottom-width: 2px; }
        
        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ */
        #menu-screen {
            justify-content: flex-start;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='480' viewBox='0 0 320 480'%3E%3Cdefs%3E%3ClinearGradient id='floor' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%235a3a22'/%3E%3Cstop offset='100%25' stop-color='%233e2b19'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='320' height='480' fill='%23222'/%3E%3Crect width='320' height='160' fill='%23444'/%3E%3Cpath d='M0,480 L320,480 L220,320 L100,320 Z' fill='url(%23floor)'/%3E%3Crect x='100' y='160' width='120' height='160' fill='%23666'/%3E%3Crect x='130' y='180' width='60' height='140' fill='%233a3a3a' border='2' stroke='%23555'/%3E%3Cpath d='M0,0 L100,160 L100,320 L0,480 Z' fill='%23888'/%3E%3Cpath d='M320,0 L220,160 L220,320 L320,480 Z' fill='%23777'/%3E%3Cline x1='0' y1='100' x2='100' y2='190' stroke='%23555' stroke-width='3'/%3E%3Cline x1='320' y1='100' x2='220' y2='190' stroke='%23555' stroke-width='3'/%3E%3C/svg%3E");
            background-size: cover; background-position: center;
        }
        /* ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°åŠ¹æœ */
        #menu-screen::after, #game-screen::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 10;
        }

        #face-off-area {
            display: flex; justify-content: space-between; align-items: flex-end;
            width: 85%; height: 220px; margin-bottom: 20px; position: relative; margin-top: 60px; z-index: 5;
        }
        .char-box { display: flex; flex-direction: column; align-items: center; transition: transform 0.5s; position: relative; z-index: 5; }
        .char-label { 
            font-size: 10px; margin-top: 5px; background: #000; border: 1px solid #fff;
            padding: 3px 8px; border-radius: 4px; color: white; 
        }
        
        .select-arrow {
            position: absolute; top: 40%; 
            font-size: 30px; color: #fff; cursor: pointer; user-select: none;
            text-shadow: 2px 2px 0 #000; z-index: 100; 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(to bottom, #444, #222); border: 2px solid #fff; border-radius: 50%;
            box-shadow: 0 4px 0 #000;
        }
        .select-arrow:active { transform: scale(0.9) translateY(2px); box-shadow: 0 2px 0 #000; }
        #arrow-left { left: -10px; }
        #arrow-right { right: -10px; }

        .menu-rank {
            position: absolute; top: -10px; right: -10px;
            width: 40px; height: 40px; border: 3px solid red; border-radius: 50%;
            color: red; font-family: 'New Tegomin', serif; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            transform: rotate(20deg); background: rgba(255, 255, 255, 0.9); 
            z-index: 10; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .menu-rank.god { border-color: purple; color: purple; font-size: 12px; font-weight: bold; }

        .walk-right { animation: walkOff 1.5s forwards linear; }
        .fade-in-right { animation: slideIn 1s forwards ease-out; }
        @keyframes walkOff { 0% { transform: translateX(0); } 100% { transform: translateX(400px) translateY(0); } }
        @keyframes slideIn { 0% { transform: translateX(200px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }

        #equip-menu {
            width: 92%; background: rgba(20,20,20,0.9); padding: 10px; border-radius: 8px; border: 2px solid #555;
            display: flex; flex-direction: column; align-items: center; margin-top: 10px; z-index: 20;
        }
        #current-equip { color: #ffd700; font-size: 10px; margin-bottom: 5px; }
        #equip-desc { color: #ccc; font-size: 9px; margin-top: 5px; height: 20px; line-height: 1.4; }
        .equip-list { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .equip-item { 
            width: 38px; height: 38px; border: 2px solid #555; background: #333; 
            display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border-radius: 4px;
        }
        .equip-item.unlocked { border-color: #888; background: #444; }
        .equip-item.selected { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; background: #554400; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen {
            justify-content: flex-start;
            background-size: cover; background-position: center;
            will-change: filter, transform;
        }
        /* ãƒªãƒã‚¹ã‚¿ãƒ¼ç‰ˆèƒŒæ™¯SVG */
        .bg-classroom { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23e0e0d0'/%3E%3Crect width='320' height='120' fill='%23ccc'/%3E%3Crect x='10' y='10' width='300' height='100' fill='%232b4528' stroke='%238b4513' stroke-width='6'/%3E%3Crect y='120' width='320' height='120' fill='%23f0f0e0'/%3E%3Crect x='10' y='130' width='60' height='80' fill='%2387ceeb' stroke='%23fff' stroke-width='4'/%3E%3Cline x1='40' y1='130' x2='40' y2='210' stroke='%23fff' stroke-width='2'/%3E%3Cline x1='10' y1='170' x2='70' y2='170' stroke='%23fff' stroke-width='2'/%3E%3Cpath d='M0,240 L320,240 L320,220 L0,220 Z' fill='%238b4513' opacity='0.5'/%3E%3Crect x='250' y='140' width='60' height='100' fill='%23ddd' stroke='%23aaa'/%3E%3C/svg%3E"); }
        .bg-science { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23ccc'/%3E%3Crect width='320' height='120' fill='%23aaa'/%3E%3Crect x='10' y='10' width='300' height='100' fill='%23224422' stroke='%23555' stroke-width='6'/%3E%3Ctext x='20' y='160' font-size='40' opacity='0.3'>ğŸ§ª</text>%3Ctext x='260' y='160' font-size='40' opacity='0.3'>ğŸ’€</text>%3Crect y='220' width='320' height='20' fill='%23222'/%3E%3C/svg%3E"); }
        .bg-music { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23d0c0a0'/%3E%3Crect width='320' height='120' fill='%23a09070'/%3E%3Crect x='10' y='10' width='300' height='100' fill='%23333' stroke='%235a3a22' stroke-width='6'/%3E%3Ctext x='140' y='70' font-size='40' fill='white' opacity='0.5'>ğŸ¼</text>%3Crect x='260' y='140' width='60' height='100' fill='%23111'/%3E%3C/svg%3E"); }
        .bg-principal { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240' viewBox='0 0 320 240'%3E%3Crect width='320' height='240' fill='%23400'/%3E%3Crect width='320' height='120' fill='%23200'/%3E%3Crect x='60' y='20' width='200' height='80' fill='%23gold' stroke='gold' stroke-width='4' opacity='0.3'/%3E%3Crect y='220' width='320' height='20' fill='%23800'/%3E%3Ctext x='10' y='150' font-size='30'>ğŸ†</text>%3Ctext x='280' y='150' font-size='30'>ğŸº</text>%3C/svg%3E"); }

        #teacher-area { height: 45vh; width: 100%; position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 30px; z-index: 5; }
        #player-area { 
            height: 55vh; width: 100%; background: rgba(20,20,20,0.6); 
            position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 10px; 
            border-top: 6px solid #5a3a22; z-index: 10;
        }
        /* â˜…è¿½åŠ : è‡ªåˆ†ã®æœºã®æç”» */
        #player-desk {
            position: absolute; bottom: 0; width: 100%; height: 120px;
            background: linear-gradient(#8b4513, #5a3a22);
            border-top: 8px solid #a0522d;
            z-index: 15; /* ã‚­ãƒ£ãƒ©ã®æ‰‹å‰ */
            display: flex; justify-content: center; align-items: center;
            color: rgba(0,0,0,0.3); font-size: 10px;
        }

        #blackboard-text { 
            position: absolute; top: 30px; width: 80%; left:10%; text-align: center; 
            font-family: serif; font-size: 14px; color: rgba(255,255,255,0.9); 
            text-shadow: 1px 1px 2px #000; z-index: 6;
        }
        
        #hud { width: 90%; display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
        #hearts { color: var(--danger-color); font-size: 24px; text-shadow: 2px 2px 0 #000; letter-spacing: 2px; }
        
        #progress-container { width: 100%; height: 16px; background: #333; border: 2px solid #fff; border-radius: 8px; overflow: hidden; margin-top: 5px; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9800, #ffd700); transition: width 0.2s; }
        #progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; color: #000; line-height: 16px; font-weight: bold; }

        .sprite { width: 160px; height: 160px; background-repeat: no-repeat; background-position: center; background-size: contain; position: relative; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        
        #active-skill-btn {
            position: absolute; bottom: 130px; right: 20px;
            width: 70px; height: 70px; border-radius: 50%;
            background: radial-gradient(circle, #ffeb3b, #fbc02d);
            border: 4px solid #fff; box-shadow: 0 0 15px #ffd700;
            display: none; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; z-index: 1000; animation: glow 2s infinite;
            -webkit-tap-highlight-color: transparent;
        }
        #active-skill-btn:active { transform: scale(0.9); }
        #active-skill-btn.cooldown { filter: grayscale(100%); opacity: 0.5; animation: none; pointer-events: none; }
        @keyframes glow { 0%,100%{box-shadow: 0 0 10px #ffd700;} 50%{box-shadow: 0 0 25px #ffd700;} }

        #config-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; background: none; border: none; z-index: 20; filter: drop-shadow(1px 1px 0 #000); }
        #exit-btn { position: absolute; top: 15px; left: 15px; font-size: 12px; cursor: pointer; background: #cc3333; color: #fff; border: 2px solid #fff; padding: 8px; border-radius: 5px; z-index: 20; box-shadow: 0 4px 0 #880000; }
        
        #config-modal, #tutorial-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .config-box { background: #222; padding: 20px; border: 4px solid #fff; text-align: center; width: 80%; border-radius: 10px; }
        .tutorial-step { margin-bottom: 15px; text-align: left; font-size: 11px; line-height: 1.8; color: #ddd; }

        .btn-endless { display: none; width: 200px; border-color: #ff00ff; color: #ff00ff; animation: pulse 1s infinite; margin-top:5px; background: #300; }
        .btn-ngplus { display: none; width: 200px; border-color: #ffd700; color: #ffd700; margin-top: 5px; background: #330; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); } }

        .chalk-missile {
            position: absolute; width: 20px; height: 6px; background: white; border-radius: 2px;
            top: 40%; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 5px rgba(255,255,255,0.8); z-index: 100; animation: flyChalk 0.3s linear forwards;
        }
        @keyframes flyChalk { 0% { top: 40%; transform: translateX(-50%) scale(1); } 100% { top: 80%; transform: translateX(-50%) scale(2) rotate(360deg); } }
        .shaking { animation: shakeScreen 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeScreen { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }

        /* ãƒªãƒã‚¹ã‚¿ãƒ¼ç‰ˆSVGã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼ˆå½±ä»˜ãï¼‰ */
        /* åŠ è—¤ */
        .kato-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='12' height='4' fill='%23222'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23ccc'/%3E%3Crect x='20' y='16' width='4' height='16' fill='%23aaa' opacity='0.3'/%3E%3C/svg%3E"); }
        .kato-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='10' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='10' height='4' fill='%23222'/%3E%3Crect x='20' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='10' y='16' width='12' height='16' fill='%23ccc'/%3E%3C/svg%3E"); }
        .kato-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='12' height='12' fill='%23ffcccc'/%3E%3Crect x='10' y='4' width='12' height='4' fill='%23222'/%3E%3Crect x='11' y='8' width='3' height='2' fill='%23000'/%3E%3Crect x='18' y='8' width='3' height='2' fill='%23000'/%3E%3Cline x1='10' y='9' x2='22' y2='9' stroke='%23000' stroke-width='1'/%3E%3Crect x='14' y='12' width='4' height='2' fill='%23a00'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23ccc'/%3E%3C/svg%3E"); }

        /* æ¾ç”° */
        .matsuda-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='8' y='4' width='16' height='12' fill='%23f0c0a0'/%3E%3Crect x='8' y='4' width='16' height='6' fill='%23622'/%3E%3Crect x='6' y='16' width='20' height='16' fill='%23d8bfd8'/%3E%3Crect x='20' y='16' width='6' height='16' fill='%23a89fb8' opacity='0.3'/%3E%3C/svg%3E"); }
        .matsuda-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='12' height='6' fill='%23622'/%3E%3Crect x='21' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='20' y='10' width='3' height='2' fill='%23f0a' opacity='0.5'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23d8bfd8'/%3E%3Crect x='2' y='6' width='8' height='14' fill='%23622'/%3E%3C/svg%3E"); }
        .matsuda-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='8' y='4' width='16' height='12' fill='%23f0c0a0'/%3E%3Cpath d='M8,4 L24,4 L24,10 L8,10 Z' fill='%23622'/%3E%3Cpath d='M6,6 L8,6 L8,16 L6,16 Z' fill='%23622'/%3E%3Cpath d='M24,6 L26,6 L26,16 L24,16 Z' fill='%23622'/%3E%3Crect x='11' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='19' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='9' y='10' width='3' height='2' fill='%23f0a' opacity='0.5'/%3E%3Crect x='20' y='10' width='3' height='2' fill='%23f0a' opacity='0.5'/%3E%3Crect x='14' y='12' width='4' height='2' fill='%23d00'/%3E%3Crect x='6' y='16' width='20' height='16' fill='%23d8bfd8'/%3E%3C/svg%3E"); }

        /* è…åŸ */
        .sugawara-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M6,2 L26,2 L26,10 L6,10 Z' fill='%23331'/%3E%3Crect x='8' y='8' width='16' height='8' fill='%23e0b090'/%3E%3Crect x='6' y='16' width='20' height='16' fill='%23456'/%3E%3Crect x='20' y='16' width='6' height='16' fill='%23234' opacity='0.3'/%3E%3C/svg%3E"); }
        .sugawara-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M8,2 L24,2 L24,10 L8,10 Z' fill='%23331'/%3E%3Crect x='10' y='8' width='12' height='8' fill='%23e0b090'/%3E%3Ccircle cx='22' cy='11' r='2' stroke='%23000' fill='none'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23456'/%3E%3C/svg%3E"); }
        .sugawara-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M6,2 L26,2 L26,10 L6,10 Z' fill='%23331'/%3E%3Crect x='8' y='8' width='16' height='8' fill='%23e0b090'/%3E%3Ccircle cx='12' cy='11' r='2' stroke='%23000' fill='none'/%3E%3Ccircle cx='20' cy='11' r='2' stroke='%23000' fill='none'/%3E%3Crect x='14' y='13' width='4' height='2' fill='%23000'/%3E%3Crect x='6' y='16' width='20' height='16' fill='%23456'/%3E%3C/svg%3E"); }

        /* ç¦ç››ç”° */
        .fukumorita-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='12' height='4' fill='%23111'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23111'/%3E%3Crect x='20' y='16' width='4' height='16' fill='%23000' opacity='0.3'/%3E%3C/svg%3E"); }
        .fukumorita-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='10' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='10' height='4' fill='%23111'/%3E%3Crect x='20' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='10' y='16' width='12' height='16' fill='%23111'/%3E%3C/svg%3E"); }
        .fukumorita-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='4' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='4' width='12' height='4' fill='%23111'/%3E%3Crect x='12' y='8' width='2' height='2' fill='%23000'/%3E%3Crect x='18' y='8' width='2' height='2' fill='%23000'/%3E%3Cpath d='M11,10 L14,10' stroke='%23000'/%3E%3Cpath d='M18,10 L21,10' stroke='%23000'/%3E%3Crect x='14' y='12' width='4' height='1' fill='%23a00'/%3E%3Crect x='8' y='16' width='16' height='16' fill='%23111'/%3E%3Cpath d='M16,16 L16,32' stroke='%23333'/%3E%3Cpath d='M19,19 Q21,21 23,18' stroke='%23fff' stroke-width='2' fill='none'/%3E%3C/svg%3E"); }

        /* é ˆè—¤ */
        .sudo-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='8' width='12' height='12' fill='%23f0c0a0'/%3E%3Cpath d='M10,8 L22,8 L22,14 L10,14 Z' fill='%23421'/%3E%3Cpath d='M22,10 L26,16 L24,18 L20,12 Z' fill='%23421'/%3E%3Crect x='8' y='20' width='16' height='12' fill='%23558855'/%3E%3Crect x='20' y='20' width='4' height='12' fill='%23336633' opacity='0.3'/%3E%3C/svg%3E"); }
        .sudo-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='12' y='8' width='10' height='12' fill='%23f0c0a0'/%3E%3Crect x='12' y='8' width='10' height='6' fill='%23421'/%3E%3Cpath d='M10,10 L6,16 L8,18 L12,12 Z' fill='%23421'/%3E%3Crect x='21' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='10' y='20' width='12' height='12' fill='%23558855'/%3E%3C/svg%3E"); }
        .sudo-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='8' width='12' height='12' fill='%23f0c0a0'/%3E%3Cpath d='M10,8 L22,8 L22,12 L10,12 Z' fill='%23421'/%3E%3Cpath d='M8,8 L10,20 L8,20 Z' fill='%23421'/%3E%3Cpath d='M22,10 L26,16 L24,18 L20,12 Z' fill='%23421'/%3E%3Crect x='12' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='18' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='14' y='16' width='4' height='1' fill='%23a00'/%3E%3Crect x='8' y='20' width='16' height='12' fill='%23558855'/%3E%3C/svg%3E"); }

        /* å¤§è°· */
        .otani-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Cpath d='M10,2 L22,2 L22,8 L10,8 Z' fill='%23111'/%3E%3Cline x1='16' y1='2' x2='16' y2='8' stroke='%23333' stroke-width='1'/%3E%3Crect x='8' y='14' width='16' height='18' fill='%23ccccff'/%3E%3Crect x='20' y='14' width='4' height='18' fill='%23aaaaff' opacity='0.3'/%3E%3C/svg%3E"); }
        .otani-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='2' width='12' height='6' fill='%23111'/%3E%3Crect x='21' y='6' width='2' height='2' fill='%23008'/%3E%3Ctext x='24' y='10' font-size='8' fill='gold'>âœ¨</text>%3Crect x='10' y='14' width='12' height='18' fill='%23ccccff'/%3E%3C/svg%3E"); }
        .otani-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Cpath d='M10,2 L16,2 L16,4 L10,8 Z' fill='%23111'/%3E%3Cpath d='M22,2 L16,2 L16,4 L22,8 Z' fill='%23111'/%3E%3Crect x='12' y='6' width='2' height='2' fill='%23008'/%3E%3Crect x='18' y='6' width='2' height='2' fill='%23008'/%3E%3Cpath d='M14,10 L18,10' stroke='%23000'/%3E%3Ctext x='24' y='10' font-size='8' fill='gold'>âœ¨</text>%3Crect x='8' y='14' width='16' height='18' fill='%23ccccff'/%3E%3Crect x='14' y='14' width='4' height='18' fill='%23fff'/%3E%3C/svg%3E"); }

        /* æ¾æ‘ */
        .matsumura-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='6' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='8' y='12' width='2' height='6' fill='%23888'/%3E%3Crect x='22' y='12' width='2' height='6' fill='%23888'/%3E%3Crect x='8' y='18' width='16' height='14' fill='%23eee'/%3E%3Crect x='20' y='18' width='4' height='14' fill='%23ccc' opacity='0.3'/%3E%3C/svg%3E"); }
        .matsumura-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='6' width='10' height='12' fill='%23f0c0a0'/%3E%3Crect x='8' y='12' width='2' height='6' fill='%23888'/%3E%3Crect x='20' y='10' width='2' height='1' fill='%23000'/%3E%3Crect x='10' y='18' width='12' height='14' fill='%23eee'/%3E%3C/svg%3E"); }
        .matsumura-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='6' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='8' y='12' width='2' height='6' fill='%23888'/%3E%3Crect x='22' y='12' width='2' height='6' fill='%23888'/%3E%3Crect x='12' y='10' width='2' height='1' fill='%23000'/%3E%3Crect x='18' y='10' width='2' height='1' fill='%23000'/%3E%3Crect x='14' y='14' width='4' height='1' fill='%23000'/%3E%3Crect x='8' y='18' width='16' height='14' fill='%23eee'/%3E%3Crect x='12' y='18' width='2' height='14' fill='%23aaa'/%3E%3C/svg%3E"); }

        /* é’ç”° */
        .aota-back { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='12' y='2' width='8' height='4' fill='%23222'/%3E%3Crect x='8' y='14' width='16' height='18' fill='%23000080'/%3E%3Crect x='20' y='14' width='4' height='18' fill='%23000050' opacity='0.3'/%3E%3C/svg%3E"); }
        .aota-side { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='2' width='12' height='4' fill='%23222'/%3E%3Crect x='21' y='6' width='2' height='1' fill='%23000'/%3E%3Crect x='8' y='14' width='14' height='18' fill='%23000080'/%3E%3C/svg%3E"); }
        .aota-face { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='2' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='12' y='2' width='8' height='4' fill='%23222'/%3E%3Crect x='10' y='4' width='2' height='6' fill='%23555'/%3E%3Crect x='20' y='4' width='2' height='6' fill='%23555'/%3E%3Crect x='13' y='6' width='2' height='1' fill='%23000'/%3E%3Crect x='17' y='6' width='2' height='1' fill='%23000'/%3E%3Cpath d='M14,10 L18,10' stroke='%23000' stroke-width='2'/%3E%3Crect x='8' y='14' width='16' height='18' fill='%23000080'/%3E%3Crect x='14' y='14' width='4' height='18' fill='%23fff'/%3E%3Crect x='15' y='16' width='2' height='10' fill='%23a00'/%3E%3C/svg%3E"); }

        .student-awake { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='8' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='8' width='12' height='4' fill='%23222'/%3E%3Crect x='12' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='18' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='8' y='20' width='16' height='12' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-sleep { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='12' width='12' height='12' fill='%23f0c0a0'/%3E%3Crect x='10' y='12' width='12' height='4' fill='%23222'/%3E%3Crect x='12' y='16' width='2' height='1' fill='%23000'/%3E%3Crect x='18' y='16' width='2' height='1' fill='%23000'/%3E%3Crect x='8' y='24' width='16' height='8' fill='%234488ff'/%3E%3C/svg%3E"); }
        .student-hurt { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='10' y='8' width='12' height='12' fill='%23ccf'/%3E%3Crect x='10' y='8' width='12' height='4' fill='%23222'/%3E%3Crect x='12' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='18' y='12' width='2' height='2' fill='%23000'/%3E%3Crect x='14' y='16' width='4' height='2' fill='%23000'/%3E%3Crect x='8' y='20' width='16' height='12' fill='%234488ff'/%3E%3C/svg%3E"); animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
        .zzz { position: absolute; color: cyan; font-size: 20px; animation: floatUp 1.5s steps(4) forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        .god-mode { color: gold !important; text-shadow: 0 0 10px gold !important; }
        
        #ending-screen { background: #111; z-index: 2000; }
        #certificate { width: 90%; background: #fff; color: #000; padding: 20px; border: 10px double #ffd700; font-family: 'New Tegomin', serif; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); animation: popIn 1s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        .btn-x { background: #000; border-color: #fff; }
        .btn-line { background: #06c755; border-color: #fff; }
        .btn-share { background: #555; border-color: #ccc; }
        
        #dialogue-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2500;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .dialogue-box {
            width: 85%; background: #fff; border: 4px solid #000; border-radius: 10px; padding: 15px;
            font-family: 'New Tegomin', serif; min-height: 120px; position: relative;
            display: flex; flex-direction: column; justify-content: center;
        }
        .dialogue-name { font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .name-teacher { color: var(--danger-color); }
        .name-you { color: #4488ff; }
        .dialogue-text { font-size: 14px; line-height: 1.5; color: #000; white-space: pre-wrap; text-align: center; }
        .dialogue-next { position: absolute; bottom: 10px; right: 10px; animation: blink 1s infinite; font-size: 20px; cursor: pointer; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .rank-stamp { font-size: 80px; color: red; transform: rotate(-20deg); text-shadow: 2px 2px 0 #fff; border: 5px solid red; border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; margin: 10px auto; animation: stamp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp { 0% { transform: scale(3) rotate(0deg); opacity: 0; } 100% { transform: scale(1) rotate(-20deg); opacity: 1; } }
    </style>
</head>
<body>
    <div id="menu-screen" class="screen">
        <h1 id="game-title" style="color:#fff; font-size:16px; margin-top:20px; text-shadow:2px 2px 0 #000; background:rgba(0,0,0,0.5); padding:5px; z-index:10; cursor:pointer;">BATTLE SELECT</h1>
        <button id="config-btn" onclick="openConfig()">âš™ï¸</button>
        <p id="cheat-msg" style="color:gold; font-size:10px; display:none; z-index:10;">GOD MODE!</p>

        <div id="face-off-area">
            <div id="arrow-left" class="select-arrow" onclick="changeStage(-1)">â—€</div>
            <div id="arrow-right" class="select-arrow" onclick="changeStage(1)">â–¶</div>

            <div id="menu-player" class="char-box"><div class="sprite student-awake"></div><div class="char-label">YOU</div></div>
            <div style="font-size:30px; color:var(--danger-color); font-weight:bold; text-shadow:2px 2px 0 #000;">VS</div>
            <div id="menu-rival" class="char-box">
                <div id="menu-rival-sprite" class="sprite"></div>
                <div id="menu-rival-name" class="char-label">???</div>
                <div id="menu-rank-display" class="menu-rank" style="display:none;"></div>
            </div>
        </div>

        <button id="start-btn" class="btn" style="width:200px; font-size:16px; background:var(--danger-color);" onclick="startSequence()">BATTLE START</button>
        
        <button id="endless-btn" class="btn btn-endless" onclick="startEndless()">ğŸ’€ ENDLESS</button>
        <button id="ng-plus-btn" class="btn btn-ngplus" style="display:none;" onclick="newGamePlus()">ğŸ’ª NEW GAME +</button>

        <div id="equip-menu">
            <div id="current-equip">è£…å‚™ãªã—</div>
            <div class="equip-list">
                <div id="skill-kato" class="equip-item" onclick="equipSkill('kato')">â±ï¸</div>
                <div id="skill-matsuda" class="equip-item" onclick="equipSkill('matsuda')">â¤ï¸</div>
                <div id="skill-sugawara" class="equip-item" onclick="equipSkill('sugawara')">ğŸµ</div>
                <div id="skill-fukumorita" class="equip-item" onclick="equipSkill('fukumorita')">ğŸ‘Ÿ</div>
                <div id="skill-sudo" class="equip-item" onclick="equipSkill('sudo')">ğŸ“œ</div>
                <div id="skill-otani" class="equip-item" onclick="equipSkill('otani')">ğŸŒ¸</div>
                <div id="skill-matsumura" class="equip-item" onclick="equipSkill('matsumura')">ğŸ§ª</div>
                <div id="skill-aota" class="equip-item" onclick="equipSkill('aota')">ğŸ§¥</div>
            </div>
            <div id="equip-desc">ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º</div>
        </div>
    </div>

    <div id="dialogue-screen" onclick="nextDialogue()">
        <div class="dialogue-box">
            <div id="diag-name" class="dialogue-name"></div>
            <div id="diag-text" class="dialogue-text"></div>
            <div class="dialogue-next">â–¼</div>
        </div>
    </div>

    <div id="tutorial-modal">
        <div class="config-box">
            <h2 style="color:var(--accent-color);">HOW TO PLAY</h2>
            <div class="tutorial-step">
                1. ç”»é¢é•·æŠ¼ã—ï¼ˆPCã¯ã‚¹ãƒšãƒ¼ã‚¹ï¼‰ã§<b>å±…çœ ã‚Š</b>ã—ã¾ã™ã€‚<br>
                2. å…ˆç”ŸãŒ<b>æ¨ªã‚’å‘ã„ãŸã‚‰ï¼ˆSideï¼‰</b>è­¦æˆ’ï¼<br>
                3. å…ˆç”ŸãŒ<b>ã“ã£ã¡ã‚’å‘ãï¼ˆFrontï¼‰å‰</b>ã«æŒ‡ã‚’é›¢ã—ã¦èµ·ãã‚ï¼<br>
                4. å„å…ˆç”Ÿã‚’å€’ã™ã¨ã€å¼·åŠ›ãª<b>èƒ½åŠ›</b>ã‚’ã‚²ãƒƒãƒˆã§ãã¾ã™ã€‚
            </div>
            <button class="btn" onclick="closeTutorial()">ã‚ã‹ã£ãŸï¼</button>
        </div>
    </div>

    <div id="config-modal">
        <div class="config-box">
            <h2 style="color:var(--accent-color);">SETTINGS</h2>
            <p style="font-size:10px; color:#aaa;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
            <button class="btn" style="border-color:#aaa; color:#fff;" onclick="openTutorial()">â“ éŠã³æ–¹ã‚’è¦‹ã‚‹</button>
            <br><br>
            <button class="btn" style="border-color:red; color:red;" onclick="hardReset()">ğŸ—‘ï¸ å®Œå…¨åˆæœŸåŒ–<br><span style="font-size:8px">(ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤)</span></button>
            <button class="btn" style="margin-top:20px;" onclick="closeConfig()">CLOSE</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <button id="exit-btn" onclick="exitBattle()">â†© EXIT</button>
        <div id="teacher-area"><div id="blackboard-text"></div><div id="teacher-sprite" class="sprite"></div></div>
        <div id="player-area">
            <div id="player-desk"></div>
            <div id="hud"><div id="hearts">â¤â¤â¤</div><div style="font-size:12px; color:#fff; font-weight:bold;">TARGET: <span id="target-score">30</span>s</div></div>
            <div id="progress-container"><div id="progress-fill"></div><div id="progress-text">0%</div></div>
            <div id="student-sprite" class="sprite student-awake"></div>
            <div id="active-skill-btn" ontouchstart="activateActiveSkill(event)" onclick="activateActiveSkill(event)">âœ¨</div>
            <div style="margin-top:20px; color:#ddd; font-size:10px; text-shadow:1px 1px 0 #000; position:absolute; bottom:10px;">HOLD SPACE TO SLEEP</div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h1 id="result-title">FAILED</h1>
        <div id="rank-stamp" class="rank-stamp" style="display:none;"></div>
        <p id="result-msg">å»Šä¸‹ã«ç«‹ã£ã¦ãªã•ã„ï¼</p>
        <button class="btn" onclick="returnToMenu()">NEXT</button>
    </div>

    <div id="ending-screen" class="screen hidden">
        <div id="certificate">
            <h2 style="border-bottom: 2px solid #000; display:inline-block; margin-bottom:20px;">ç¡çœ å’æ¥­è¨¼æ›¸</h2>
            <p>æ®¿</p>
            <p style="font-size:12px; line-height:2;">ã‚ãªãŸã¯å…¨ã¦ã®å…ˆç”Ÿã®ç›®ã‚’ç›—ã¿<br>é’ç”°æ ¡é•·ã™ã‚‰ã‚‚ä¹—ã‚Šè¶Šãˆ<br>å®Œå…¨çˆ†ç¡ã—ãŸã“ã¨ã‚’è¨¼ã—ã¾ã™ã€‚</p>
            <p id="god-mode-note" style="font-size:10px; color:purple; display:none; margin-top:10px;">â€»ã‚´ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®ä½¿ç”¨ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚</p>
            <p style="text-align:right; margin-top:20px;">2025å¹´ ç¡çœ å§”å“¡ä¼š</p>
            <div style="font-size:40px; margin-top:10px;">ğŸ’®</div>
        </div>
        <div class="share-container">
            <button class="btn btn-x" onclick="shareX()">Xã§è‡ªæ…¢</button>
            <button class="btn btn-line" onclick="shareLine()">LINE</button>
            <button class="btn btn-share" onclick="shareNative()">å…±æœ‰/ã‚³ãƒ”ãƒ¼</button>
        </div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
    </div>

    <script>
        const GAME_URL = "https://kato-game-1.onrender.com";
        const teachers = {
            1: { name: "kato", label: "Math / Kato", target: 15, speed: 1.0, blackboard: "y = axÂ² + ...", face:"kato-face", bg:"bg-classroom" },
            2: { name: "matsuda", label: "English / Matsuda", target: 20, speed: 1.2, blackboard: "Open your textbook...", face:"matsuda-face", bg:"bg-classroom" },
            3: { name: "sugawara", label: "Music / Sugawara", target: 25, speed: 0.8, blackboard: "â™ª ~ â™« ~ â™ª", face:"sugawara-face", bg:"bg-music" },
            4: { name: "fukumorita", label: "Boss / Fukumorita", target: 30, speed: 1.5, blackboard: "FUTURE PATH...", face:"fukumorita-face", bg:"bg-classroom" },
            5: { name: "sudo", label: "Social / Sudo", target: 35, speed: 1.1, blackboard: "1192 Kamakura...", face:"sudo-face", bg:"bg-classroom" },
            6: { name: "otani", label: "Classic / Otani", target: 40, speed: 1.3, blackboard: "Haru wa Akebono...", face:"otani-face", bg:"bg-classroom" },
            7: { name: "matsumura", label: "Science / Matsumura", target: 45, speed: 0.9, blackboard: "H2O + CO2...", face:"matsumura-face", bg:"bg-science" },
            8: { name: "aota", label: "FINAL / Principal Aota", target: 60, speed: 2.0, blackboard: "SILENCE IS GOLD", face:"aota-face", bg:"bg-principal" },
            9: { name: "endless", label: "ENDLESS SURVIVAL", target: 9999, speed: 1.0, blackboard: "SURVIVAL MODE", face:"fukumorita-face", bg:"bg-classroom" }
        };
        const skillData = {
            "kato": { name: "åŠ è—¤ã®æ™‚è¨ˆ", desc: "ã€Aã€‘æ™‚é–“ã‚’3ç§’æ­¢ã‚ã‚‹", active: true, icon: "â±ï¸" },
            "matsuda": { name: "æ¾ç”°ã®ãƒ©ãƒ³ãƒ", desc: "ã€Pã€‘ãƒ©ã‚¤ãƒ•+1", active: false, icon: "â¤ï¸" },
            "sugawara": { name: "è…åŸã®ã‚¿ã‚¯ãƒˆ", desc: "ã€Pã€‘ç¡çœ é€Ÿåº¦1.5å€", active: false, icon: "ğŸµ" },
            "fukumorita": { name: "ç¦ç››ç”°ã®ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼", desc: "ã€Pã€‘å¯ã‚‹ã»ã©åŠ é€Ÿ(æœ€å¤§3å€)", active: false, icon: "ğŸ‘Ÿ" },
            "sudo": { name: "é ˆè—¤ã®æš—è¨˜ã‚«ãƒ¼ãƒ‰", desc: "ã€Aã€‘ä¸€ç¬ã§5ç§’åˆ†ã‚¹ã‚³ã‚¢ç²å¾—", active: true, icon: "ğŸ“œ" },
            "otani": { name: "å¤§è°·ã®å’Œæ­Œ", desc: "ã€Pã€‘å…ˆç”ŸãŒè¦‹ã‚‹æ™‚é–“ãŒçŸ­ããªã‚‹", active: false, icon: "ğŸŒ¸" },
            "matsumura": { name: "æ¾æ‘ã®åŠ‡è–¬", desc: "ã€Aã€‘5ç§’é–“ç„¡æ•µã«ãªã‚‹", active: true, icon: "ğŸ§ª" },
            "aota": { name: "æ ¡é•·ã®ã‚¸ãƒ£ã‚±ãƒƒãƒˆ", desc: "ã€Pã€‘ç¡çœ é€Ÿåº¦5.0å€", active: false, icon: "ğŸ§¥" }
        };
        const dialogues = {
            1: { t: "ã“ã‚“ãªã‚“ã§å¯ã¦ã‚“ã ã£ãŸã‚‰\nãŠå‰ã‚‚ã†ãƒã‚¸ã§çŸ¥ã‚‰ã‚“ã€‚", s: "ã¾ã•ã‹ï¼å¯ã‚‹ã‚ã‘ãªã„ã§ã™ï¼\n(ä»Šã®ã†ã¡ã«...)" },
            2: { t: "Sleeping is... death.", s: "No, no! I love English!\n(zzz...)" },
            3: { t: "ã—ã‚ƒãƒ¼ã¹ã‚‹ã¨... ã“ã‚“ãª... ã‹ã‚“ã˜...", s: "ï¼ˆå–‹ã‚Šæ–¹ãŒé…ãã¦çœ ããªã‚‹...ï¼‰" },
            4: { t: "ã‚¢ãƒ‡ã‚£...ãƒ€ã‚¹...ï¼Ÿ", s: "ï¼ˆãƒŠã‚¤ã‚­ã§ã™å…ˆç”Ÿ...ï¼‰" },
            5: { t: "éŒå€‰å¹•åºœã‚’æ»…äº¡ã•ã›ã¾ã™ã€‚", s: "å¹³å’Œã«ã„ãã¾ã—ã‚‡ã†ã‚ˆ...\nï¼ˆã‚¹ãƒ¤ã‚¡ï¼‰" },
            6: { t: "æ˜¥ã¯ã‚ã‘ã¼ã®...ã ãŒã€\nå›ã®å¯é¡”ã¯é¢¨æµã§ã¯ãªã„ãªã€‚", s: "ã„ã¨çœ ã—...ã§ã™..." },
            7: { t: "ã¡ã‚‡ã£ã¨ãŠè…¹ãŒé³´ã£ã¡ã‚ƒã£ãŸãªã€‚", s: "ï¼ˆä»Šã®ã†ã¡ã«å¯ã‚ˆã†ï¼‰" },
            8: { t: "æˆ‘ãŒæ ¡ã¯100å¹´ã®æ­´å²ã‚’èª‡ã‚‹ä¼çµ±æ ¡ã§ã‚ã‚‹ã€‚\nãã®æ ¡é•·ã§ã‚ã‚‹ç§ã®å¾¡å‰ã§çœ ã‚ã†ãªã©ã€\nè¨€èªé“æ–­ï¼è²´æ§˜ã®è¦šæ‚Ÿã€è¦‹ã›ã¦ã‚‚ã‚‰ãŠã†ã‹ï¼", s: "ï¼ˆè©±ãŒé•·ã„...ãŠã‚„ã™ã¿ãªã•ã„ï¼‰" },
            9: { t: "çµ‚ã‚ã‚‰ãªã„æ‚ªå¤¢ã¸ã‚ˆã†ã“ã...", s: "ï¼ˆè¨˜éŒ²æ›´æ–°ã—ã¦ã‚„ã‚‹ï¼ï¼‰" }
        };

        const teacherNames = ["kato", "matsuda", "sugawara", "fukumorita", "sudo", "otani", "matsumura", "aota"];
        
        let unlockedStage = parseInt(localStorage.getItem("soichiGameStage")) || 1;
        let unlockedPowers = JSON.parse(localStorage.getItem("soichiPowers")) || [];
        let stageRanks = JSON.parse(localStorage.getItem("soichiRanks")) || {};
        
        let equippedPower = localStorage.getItem("soichiEquippedPower");
        if (equippedPower === "null") equippedPower = null;

        let currentMenuStage = (unlockedStage > 8) ? 8 : unlockedStage; 
        let battleStage = 1;

        let justCleared = false;
        let hp = 3, sleepTime = 0, isSleeping = false, isTeacherLooking = false, isInvincible = false;
        let gameLoopId, teacherTimerId, zzzInterval, isGodMode = false, tapCount = 0, endlessSpeed = 1.0;
        let isTimeStopped = false, sleepContinuous = 0;
        let dialogueStep = 0;
        // â˜…ãƒã‚°ä¿®æ­£: é–‹å§‹ç›´å¾Œã®å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯
        let isInputBlocked = false;

        const AudioContext = window.AudioContext || window.webkitAudioContext; let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'dead') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'clear') { osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(880, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'skill') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.linearRampToValueAtTime(1760, now+0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.5); osc.start(now); osc.stop(now+0.5); }
        }

        function initMenu() {
            if (!localStorage.getItem("soichiTutorialSeen")) {
                openTutorial();
                localStorage.setItem("soichiTutorialSeen", "true");
            }
            currentMenuStage = (unlockedStage > 8) ? 8 : unlockedStage;
            updateMenuVisuals(currentMenuStage);
            
            const endlessBtn = document.getElementById("endless-btn");
            const ngBtn = document.getElementById("ng-plus-btn");
            
            if (unlockedStage >= 9) {
                endlessBtn.style.display = "block";
                ngBtn.style.display = "block";
            } else {
                endlessBtn.style.display = "none";
                ngBtn.style.display = "none";
            }
            renderEquipMenu();
        }

        function changeStage(dir) {
            let max = (unlockedStage > 8) ? 8 : unlockedStage;
            let next = currentMenuStage + dir;
            if (next < 1) next = max;
            if (next > max) next = 1;
            currentMenuStage = next;
            updateMenuVisuals(currentMenuStage);
        }

        function updateMenuVisuals(stageNum) {
            const t = teachers[stageNum];
            const rivalSprite = document.getElementById("menu-rival-sprite");
            const rivalName = document.getElementById("menu-rival-name");
            const rankDisplay = document.getElementById("menu-rank-display");
            
            const leftArrow = document.getElementById("arrow-left");
            const rightArrow = document.getElementById("arrow-right");
            if (unlockedStage <= 1) {
                leftArrow.style.display = "none"; rightArrow.style.display = "none";
            } else {
                leftArrow.style.display = "block"; rightArrow.style.display = "block";
            }

            rivalSprite.className = `sprite ${t.face}`;
            rivalName.textContent = t.label;

            const rank = stageRanks[stageNum];
            rankDisplay.classList.remove("god");
            if (rank) {
                rankDisplay.textContent = rank;
                rankDisplay.style.display = "flex";
                if (rank === "ãƒãƒ¼ãƒˆ") rankDisplay.classList.add("god");
            } else {
                rankDisplay.style.display = "none";
            }
        }

        function renderEquipMenu() {
            const descEl = document.getElementById("equip-desc");
            if (equippedPower && skillData[equippedPower]) {
                document.getElementById("current-equip").textContent = `è£…å‚™ä¸­: ${skillData[equippedPower].name}`;
                descEl.textContent = skillData[equippedPower].desc;
            } else {
                document.getElementById("current-equip").textContent = "è£…å‚™ãªã—";
                descEl.textContent = "ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º";
            }
            
            Object.keys(skillData).forEach(p => {
                const el = document.getElementById(`skill-${p}`);
                if(el) {
                    if (unlockedPowers.includes(p)) { 
                        el.style.display = "flex"; 
                        el.classList.add("unlocked"); 
                    } else { 
                        el.style.display = "none"; 
                    }
                    if (equippedPower === p) el.classList.add("selected"); 
                    else el.classList.remove("selected");
                }
            });
        }

        function equipSkill(power) {
            const descEl = document.getElementById("equip-desc");
            descEl.textContent = skillData[power].desc;
            if (equippedPower === power) equippedPower = null; else equippedPower = power;
            localStorage.setItem("soichiEquippedPower", equippedPower);
            renderEquipMenu();
        }

        function openConfig() { document.getElementById("config-modal").style.display = "flex"; }
        function closeConfig() { document.getElementById("config-modal").style.display = "none"; }
        function openTutorial() { document.getElementById("tutorial-modal").style.display = "flex"; }
        function closeTutorial() { document.getElementById("tutorial-modal").style.display = "none"; }
        
        function newGamePlus() {
            if(confirm("èƒ½åŠ›ã¯ãã®ã¾ã¾ã§ã€ã‚¹ãƒ†ãƒ¼ã‚¸1ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.setItem("soichiGameStage", 1);
                localStorage.removeItem("soichiRanks");
                location.reload();
            }
        }
        function hardReset() {
            if(confirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        document.getElementById("game-title").addEventListener("click", () => { tapCount++; if(tapCount >= 7 && !isGodMode) { isGodMode = true; document.getElementById("cheat-msg").style.display = "block"; document.getElementById("game-title").classList.add("god-mode"); alert("éš ã—ã‚³ãƒãƒ³ãƒ‰æˆåŠŸï¼ç„¡æ•µãƒ¢ãƒ¼ãƒ‰ONï¼"); } });

        function startSequence() { startDialogue(currentMenuStage); }
        function startEndless() { startDialogue(9); }

        function startDialogue(st) {
            battleStage = st;
            dialogueStep = 0;
            const d = dialogues[st] || { t: "...", s: "..." };
            
            document.getElementById("menu-screen").classList.add("hidden");
            document.getElementById("dialogue-screen").style.display = "flex";
            
            document.getElementById("diag-name").textContent = teachers[st].label.split(" / ")[1] || "TEACHER";
            document.getElementById("diag-name").className = "dialogue-name name-teacher";
            document.getElementById("diag-text").textContent = d.t;
        }

        function nextDialogue() {
            dialogueStep++;
            const st = battleStage;
            const d = dialogues[st] || { t: "...", s: "..." };

            if (dialogueStep === 1) {
                document.getElementById("diag-name").textContent = "YOU";
                document.getElementById("diag-name").className = "dialogue-name name-you";
                document.getElementById("diag-text").textContent = d.s;
            } else {
                document.getElementById("dialogue-screen").style.display = "none";
                realStartBattle();
            }
        }

        function realStartBattle() {
            initAudio();
            hp = (equippedPower === 'matsuda') ? 4 : 3;
            isTimeStopped = false; sleepContinuous = 0; isInvincible = false;
            isSleeping = false; // â˜…æ˜ç¤ºçš„ã«ãƒªã‚»ãƒƒãƒˆ
            isInputBlocked = true; // â˜…é–‹å§‹ç›´å¾Œã®å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯
            setTimeout(() => { isInputBlocked = false; }, 500); // 0.5ç§’å¾Œã«è§£é™¤
            
            const skillBtn = document.getElementById("active-skill-btn");
            if (equippedPower && skillData[equippedPower].active) {
                skillBtn.style.display = "flex"; 
                skillBtn.classList.remove("cooldown");
                skillBtn.textContent = skillData[equippedPower].icon;
            } else { 
                skillBtn.style.display = "none"; 
            }
            
            sleepTime = 0; isTeacherLooking = false; endlessSpeed = 1.0;
            document.getElementById("game-screen").classList.remove("hidden");
            
            const t = teachers[battleStage];
            const gameScreen = document.getElementById("game-screen");
            gameScreen.className = `screen ${t.bg}`;

            document.getElementById("blackboard-text").textContent = t.blackboard;
            document.getElementById("target-score").textContent = (battleStage===9) ? "âˆ" : t.target;
            document.getElementById("student-sprite").className = "sprite student-awake"; // â˜…åˆæœŸåŒ–

            updateHearts(); updateProgress(); updateTeacherBehavior();
            gameLoopId = setInterval(gameLoop, 100);
        }

        function exitBattle() {
            clearInterval(gameLoopId);
            clearTimeout(teacherTimerId);
            document.getElementById("game-screen").classList.add("hidden");
            document.getElementById("menu-screen").classList.remove("hidden");
            initMenu();
        }

        window.activateActiveSkill = function(event) {
            if(event) event.stopPropagation(); 
            if(isInputBlocked) return; // ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã¯åå¿œã—ãªã„
            
            const btn = document.getElementById("active-skill-btn");
            if (btn.classList.contains("cooldown")) return;
            
            playSound('skill');
            btn.classList.add("cooldown");

            if (equippedPower === 'kato') {
                isTimeStopped = true;
                isTeacherLooking = false; clearTimeout(teacherTimerId);
                const sprite = document.getElementById("teacher-sprite");
                let tName = getTeacherName(battleStage, sprite);
                sprite.className = `sprite ${tName}-back`; 
                document.getElementById("game-screen").style.filter = "invert(1)";
                setTimeout(() => { isTimeStopped = false; document.getElementById("game-screen").style.filter = "none"; updateTeacherBehavior(); }, 3000);
            
            } else if (equippedPower === 'sudo') {
                sleepTime += 5.0;
                updateProgress();
            
            } else if (equippedPower === 'matsumura') {
                isInvincible = true;
                document.getElementById("student-sprite").style.opacity = "0.5";
                setTimeout(() => { isInvincible = false; document.getElementById("student-sprite").style.opacity = "1"; }, 5000);
            }
        };

        function getTeacherName(st, spriteEl) {
            if (st === 9) {
                for (let name of teacherNames) {
                    if (spriteEl.className.includes(name)) return name;
                }
                return "kato";
            }
            return teachers[st].name;
        }

        function updateTeacherBehavior() {
            if (isTimeStopped) return;
            let tName = teachers[battleStage].name;
            if (battleStage === 9) { tName = teacherNames[Math.floor(Math.random() * teacherNames.length)]; endlessSpeed += 0.05; }
            const sprite = document.getElementById("teacher-sprite"); 
            sprite.className = `sprite ${tName}-back`; 
            isTeacherLooking = false;
            
            let waitBase = 2000; 
            if (tName === 'sugawara') waitBase = 3000; 
            if (tName === 'fukumorita') waitBase = 1000;
            if (tName === 'aota') waitBase = 800;

            let speed = (battleStage === 9) ? endlessSpeed : teachers[battleStage].speed;
            let randomTime = (Math.random() * waitBase + 1000) / speed;
            teacherTimerId = setTimeout(() => {
                if (isTimeStopped) return;
                sprite.className = `sprite ${tName}-side`;
                
                setTimeout(() => {
                    if (isTimeStopped) return;
                    sprite.className = `sprite ${tName}-face`; 
                    isTeacherLooking = true;
                    
                    let lookBase = 1000;
                    if (equippedPower === 'otani') lookBase = 500; 
                    let lookTime = (battleStage === 9) ? Math.max(400, lookBase - endlessSpeed*50) : lookBase;
                    
                    setTimeout(() => { updateTeacherBehavior(); }, lookTime);

                }, 300);

            }, randomTime);
        }

        function gameLoop() {
            if (isSleeping) {
                sleepContinuous += 0.1;
                let speedMultiplier = 1.0;
                if (equippedPower === 'sugawara') speedMultiplier = 1.5;
                if (equippedPower === 'fukumorita') { let boost = 1.0 + (sleepContinuous * 0.2); if(boost > 3.0) boost = 3.0; speedMultiplier = boost; }
                if (equippedPower === 'aota') speedMultiplier = 5.0;

                let cheatMultiplier = isGodMode ? 5.0 : 1.0;
                sleepTime += 0.1 * speedMultiplier * cheatMultiplier;
                updateProgress();
                if (isTeacherLooking && !isInvincible) takeDamage();
            }
        }

        function updateProgress() { 
            if(battleStage === 9) { 
                document.getElementById("progress-container").style.display = "none"; 
                document.getElementById("target-score").textContent = sleepTime.toFixed(1); 
            } else { 
                document.getElementById("progress-container").style.display = "block";
                const t = teachers[battleStage]; 
                const pct = Math.min(100, (sleepTime / t.target) * 100); 
                document.getElementById("progress-fill").style.width = pct + "%"; 
                document.getElementById("progress-text").textContent = Math.floor(pct) + "%";
                if (sleepTime >= t.target) stageClear(); 
            } 
        }
        
        function takeDamage() {
            if(isGodMode) return;
            hp--; updateHearts(); playSound('dead'); isInvincible = true;
            
            const gameScreen = document.getElementById("game-screen");
            gameScreen.classList.remove("shaking");
            void gameScreen.offsetWidth;
            gameScreen.classList.add("shaking");

            const chalk = document.createElement("div"); chalk.className = "chalk-missile"; document.getElementById("game-screen").appendChild(chalk); setTimeout(() => chalk.remove(), 300);
            document.getElementById("student-sprite").className = "sprite student-hurt"; document.getElementById("game-screen").style.backgroundColor = "#500"; if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            setTimeout(() => { document.getElementById("game-screen").style.backgroundColor = "transparent"; isInvincible = false; if(isSleeping) document.getElementById("student-sprite").className = "sprite student-sleep"; else document.getElementById("student-sprite").className = "sprite student-awake"; }, 500);
            if (hp <= 0) gameOver();
        }
        function updateHearts() { let h = ""; for(let i=0; i<hp; i++) h += "â¤"; const heartEl = document.getElementById("hearts"); heartEl.textContent = h; if(isGodMode) heartEl.classList.add("god-mode"); }

        function stageClear() {
            clearInterval(gameLoopId); clearTimeout(teacherTimerId); playSound('clear');
            let gotPower = false;
            let dropped = "";
            if (battleStage === 1 && !unlockedPowers.includes("kato")) { dropped="kato"; gotPower = true; alert("åŠ è—¤å…ˆç”Ÿã®ã€Œæ‡ä¸­æ™‚è¨ˆã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 2 && !unlockedPowers.includes("matsuda")) { dropped="matsuda"; gotPower = true; alert("æ¾ç”°å…ˆç”Ÿã®ã€Œãƒ©ãƒ³ãƒã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 3 && !unlockedPowers.includes("sugawara")) { dropped="sugawara"; gotPower = true; alert("è…åŸå…ˆç”Ÿã®ã€Œã‚¿ã‚¯ãƒˆã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 4 && !unlockedPowers.includes("fukumorita")) { dropped="fukumorita"; gotPower = true; alert("ç¦ç››ç”°å…ˆç”Ÿã®ã€Œã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼ã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 5 && !unlockedPowers.includes("sudo")) { dropped="sudo"; gotPower = true; alert("é ˆè—¤å…ˆç”Ÿã®ã€Œæš—è¨˜ã‚«ãƒ¼ãƒ‰ã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 6 && !unlockedPowers.includes("otani")) { dropped="otani"; gotPower = true; alert("å¤§è°·å…ˆç”Ÿã®ã€Œå’Œæ­Œã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 7 && !unlockedPowers.includes("matsumura")) { dropped="matsumura"; gotPower = true; alert("æ¾æ‘å…ˆç”Ÿã®ã€ŒåŠ‡è–¬ã€ã‚’å¥ªã£ãŸï¼"); }
            if (battleStage === 8 && !unlockedPowers.includes("aota")) { dropped="aota"; gotPower = true; alert("é’ç”°æ ¡é•·ã®ã€Œã‚¸ãƒ£ã‚±ãƒƒãƒˆã€ã‚’å¥ªã£ãŸï¼"); }
            
            if(gotPower) { unlockedPowers.push(dropped); localStorage.setItem("soichiPowers", JSON.stringify(unlockedPowers)); }

            let rank = "B";
            if (isGodMode) {
                rank = "ãƒãƒ¼ãƒˆ"; 
            } else if(hp === 3) {
                rank = "S";
            } else if(hp === 2) {
                rank = "A";
            }
            
            const currentRank = stageRanks[battleStage];
            const rankOrder = { "S": 4, "A": 3, "B": 2, "ãƒãƒ¼ãƒˆ": 1, undefined: 0 };
            if (rankOrder[rank] > rankOrder[currentRank] || (rank === "ãƒãƒ¼ãƒˆ" && !currentRank)) {
                 stageRanks[battleStage] = rank;
                 localStorage.setItem("soichiRanks", JSON.stringify(stageRanks));
            }

            if (battleStage === 8) {
                if (unlockedStage < 9) { unlockedStage = 9; localStorage.setItem("soichiGameStage", unlockedStage); }
                showEnding(); return;
            } else if(battleStage >= unlockedStage) {
                unlockedStage++; localStorage.setItem("soichiGameStage", unlockedStage);
                justCleared = true; 
            }
            document.getElementById("game-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.remove("hidden");
            
            const stamp = document.getElementById("rank-stamp");
            stamp.style.display = "flex";
            stamp.textContent = rank;
            stamp.classList.remove("god");
            if (rank === "ãƒãƒ¼ãƒˆ") stamp.classList.add("god");

            document.getElementById("result-screen").style.background = "#2b4528";
            document.getElementById("result-title").textContent = "YOU WIN!";
            document.getElementById("result-title").style.color = "gold";
            document.getElementById("result-msg").textContent = gotPower ? "æ–°ã—ã„èƒ½åŠ›ã‚’ã‚²ãƒƒãƒˆï¼" : "æ¬¡ã®ç›¸æ‰‹ã¸...";
        }

        function returnToMenu() {
            document.getElementById("result-screen").classList.add("hidden");
            document.getElementById("menu-screen").classList.remove("hidden");
            renderEquipMenu();
            if (justCleared && battleStage < 9) { 
                justCleared = false; 
                playWalkAnimation(); 
            } else { 
                currentMenuStage = battleStage;
                if (unlockedStage > currentMenuStage && unlockedStage <= 8) { currentMenuStage = unlockedStage; }
                updateMenuVisuals(currentMenuStage); 
            }
        }

        function playWalkAnimation() {
            currentMenuStage = battleStage; 
            updateMenuVisuals(currentMenuStage); 
            const player = document.getElementById("menu-player");
            const rival = document.getElementById("menu-rival");
            rival.style.opacity = "0"; player.classList.add("walk-right");
            setTimeout(() => {
                currentMenuStage = unlockedStage > 8 ? 8 : unlockedStage; 
                updateMenuVisuals(currentMenuStage); 
                rival.style.opacity = "1"; rival.classList.add("fade-in-right"); player.classList.remove("walk-right");
                setTimeout(() => { rival.classList.remove("fade-in-right"); }, 1000);
            }, 1500); 
        }

        function gameOver() { clearInterval(gameLoopId); clearTimeout(teacherTimerId); document.getElementById("game-screen").classList.add("hidden"); document.getElementById("result-screen").classList.remove("hidden"); document.getElementById("rank-stamp").style.display = "none"; document.getElementById("result-screen").style.background = "#500"; document.getElementById("result-title").textContent = "GAME OVER"; document.getElementById("result-title").style.color = "red"; let msg = "è£œç¿’æ±ºå®š..."; if (battleStage === 9) msg = `è¨˜éŒ²: ${sleepTime.toFixed(1)}ç§’`; document.getElementById("result-msg").textContent = msg; }
        
        function showEnding() { 
            document.getElementById("game-screen").classList.add("hidden"); 
            document.getElementById("ending-screen").classList.remove("hidden"); 

            let usedGodMode = false;
            for(let i=1; i<=8; i++) { if(stageRanks[i] === "ãƒãƒ¼ãƒˆ") usedGodMode = true; }
            const godNote = document.getElementById("god-mode-note");
            if(usedGodMode) { godNote.style.display = "block"; } else { godNote.style.display = "none"; }

            for(let i=0; i<50; i++) { const conf = document.createElement("div"); conf.className = "confetti"; conf.style.left = Math.random() * 100 + "vw"; conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`; conf.style.animationDuration = (Math.random() * 2 + 2) + "s"; document.getElementById("ending-screen").appendChild(conf); } 
        }
        const shareText = "ã€è¨¼æ˜æ›¸ã€‘ç§ã¯åŠ è—¤ãƒ»æ¾ç”°ãƒ»è…åŸãƒ»ç¦ç››ç”°ãƒ»é ˆè—¤ãƒ»å¤§è°·ãƒ»æ¾æ‘ãƒ»é’ç”°æ ¡é•·ã®ç›®ã‚’ç›—ã¿ã€å®Œå…¨çˆ†ç¡ã—ãŸã“ã¨ã‚’è¨¼æ˜ã—ã¾ã™ã€‚ #åŠ è—¤å…ˆç”Ÿã‚²ãƒ¼ãƒ ";
        function shareX() { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(GAME_URL)}`, '_blank'); }
        function shareLine() { const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(GAME_URL)}`; window.open(lineUrl, '_blank'); }
        async function shareNative() { if (navigator.share) { try { await navigator.share({ title: 'æ¿€é—˜ï¼åŠ è—¤å…ˆç”Ÿã®æˆæ¥­', text: shareText, url: GAME_URL, }); } catch (err) { console.log('Share canceled'); } } else { navigator.clipboard.writeText(`${shareText} ${GAME_URL}`); alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"); } }
        
        const startSleep = () => { 
            if(isInputBlocked) return;
            isSleeping = true; 
            if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-sleep"; 
            if (!zzzInterval) zzzInterval = setInterval(spawnZzz, 400); 
        };
        const stopSleep = () => { 
            isSleeping = false; 
            sleepContinuous = 0; 
            if(!isInvincible) document.getElementById("student-sprite").className = "sprite student-awake"; 
            if (zzzInterval) { clearInterval(zzzInterval); zzzInterval = null; } 
        };
        function spawnZzz() { const zzz = document.createElement("div"); zzz.className = "zzz"; zzz.textContent = "z"; zzz.style.left = "50%"; zzz.style.top = "0px"; document.getElementById("player-area").appendChild(zzz); setTimeout(() => zzz.remove(), 1500); }
        
        const touchLayer = document.getElementById("player-area"); 
        touchLayer.addEventListener("touchstart", (e) => { 
            if(e.target.id === "active-skill-btn") return;
            initAudio(); e.preventDefault(); startSleep(); 
        }); 
        touchLayer.addEventListener("touchend", (e) => { 
            if(e.target.id === "active-skill-btn") return;
            e.preventDefault(); stopSleep(); 
        }); 
        document.addEventListener("keydown", (e) => { 
            if (e.code === "Space") { 
                if(isInputBlocked) return;
                initAudio(); startSleep(); 
            } 
        }); 
        document.addEventListener("keyup", (e) => { if (e.code === "Space") stopSleep(); });

        initMenu();
    </script>
</body>
</html>