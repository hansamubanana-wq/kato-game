<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATH CLASS: PIXEL PERFECT FIX</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111;
            --accent-color: #80ff80;
            --danger-color: #ff4040;
            --text-color: #eee;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            /* SVGをドット絵っぽくクッキリ表示 */
            image-rendering: pixelated; 
        }

        /* ブラウン管風ライン */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
        }

        .screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
        }
        .hidden { display: none !important; }

        /* ゲーム画面 */
        #game-screen { justify-content: flex-start; }

        #teacher-area {
            height: 45vh;
            width: 100%;
            border-bottom: 4px solid var(--accent-color);
            background: #222;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
        }

        /* プレイヤーエリア */
        #player-area {
            height: 55vh;
            width: 100%;
            background-color: #333;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 30px;
            border-top: 4px solid #000;
        }

        /* キャラクター表示用（共通設定） */
        .sprite {
            width: 120px;
            height: 120px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        /* ▼▼▼ ここが魔法のSVG画像データ ▼▼▼ */
        
        /* 先生：書いている（背中） */
        .teacher-writing {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3Crect x='8' y='5' width='2' height='1' fill='%23fff'/%3E%3C/svg%3E");
        }
        /* 先生：チラ見 */
        .teacher-peeking {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E");
        }
        /* 先生：怒る（こっち見てる） */
        .teacher-angry {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='1' width='4' height='4' fill='%23ffcccc'/%3E%3Crect x='3' y='1' width='4' height='1' fill='%23444'/%3E%3Crect x='4' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='2' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='4' width='3' height='1' fill='%23a00'/%3E%3Crect x='2' y='5' width='6' height='5' fill='%23ccc'/%3E%3C/svg%3E");
        }

        /* 生徒：起きている */
        .student-awake {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='4' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='6' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E");
        }
        /* 生徒：寝ている */
        .student-sleeping {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='3' width='4' height='4' fill='%23f0c0a0'/%3E%3Crect x='3' y='3' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='4' width='1' height='1' fill='%23000'/%3E%3Crect x='2' y='7' width='6' height='3' fill='%234488ff'/%3E%3C/svg%3E");
            transform: translateY(10px); /* 少し下に沈む */
        }
        /* 生徒：バレた（青ざめる） */
        .student-busted {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'%3E%3Crect width='10' height='10' fill='transparent'/%3E%3Crect x='3' y='2' width='4' height='4' fill='%23aaccff'/%3E%3Crect x='3' y='2' width='4' height='1' fill='%23222'/%3E%3Crect x='3' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='7' y='3' width='1' height='1' fill='%23000'/%3E%3Crect x='4' y='5' width='3' height='1' fill='%23000'/%3E%3Crect x='2' y='6' width='6' height='4' fill='%234488ff'/%3E%3C/svg%3E");
            animation: shake 0.2s infinite;
        }

        /* ▲▲▲ 魔法終わり ▲▲▲ */

        @keyframes shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 0); }
            75% { transform: translate(5px, 0); }
            100% { transform: translate(0, 0); }
        }

        /* Zzz アニメーション */
        .zzz {
            position: absolute;
            color: var(--accent-color);
            font-size: 20px;
            animation: floatUp 1.5s steps(4) forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }

        #score-board { font-size: 20px; margin: 10px; color: var(--accent-color); }
        #high-score { font-size: 12px; color: #888; margin-top: 10px;}

        /* UIパーツ */
        .btn {
            font-family: 'Press Start 2P', cursive;
            background: var(--accent-color);
            border: 4px solid #000;
            padding: 15px 20px;
            font-size: 16px;
            color: #000;
            cursor: pointer;
            margin-top: 30px;
        }
        .btn:active { transform: translate(4px, 4px); }

        h1 { font-size: 24px; line-height: 1.5; color: var(--accent-color); margin-bottom: 20px; }
        .blink { animation: blinker 0.5s step-end infinite alternate; color: var(--danger-color); }
        @keyframes blinker { to { opacity: 0; } }
        #result-screen { background: #300; color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="title-screen" class="screen">
        <h1>MATH CLASS<br>PIXEL PANIC</h1>
        <div style="display: flex; gap: 20px; margin: 30px;">
             <div class="sprite student-sleeping"></div>
             <div style="font-size:20px; align-self:center;">VS</div>
             <div class="sprite teacher-angry"></div>
        </div>
        <p class="blink" style="font-size: 12px; margin-top: 20px;">PRESS START</p>
        <button class="btn" onclick="startGame()">GAME START</button>
        <p id="high-score-title" style="font-size: 12px; margin-top: 30px;">TOP: 0.0</p>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="teacher-area">
            <div id="teacher-sprite" class="sprite teacher-writing"></div>
        </div>

        <div id="player-area">
            <div id="student-sprite" class="sprite student-awake"></div>
            <div id="score-board">SCORE: 0.0</div>
            <div id="high-score">HI: 0.0</div>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h1 style="color: var(--danger-color);">!! BUSTED !!</h1>
        <div style="display: flex; gap: 20px; justify-content: center;">
            <div class="sprite student-busted"></div>
            <div class="sprite teacher-angry"></div>
        </div>
        <div style="font-size: 32px; margin: 30px 0; color: var(--accent-color);" id="final-score">SCORE: 0.0</div>
        <button class="btn" onclick="location.reload()">RETRY</button>
    </div>

    <script>
        const titleScreen = document.getElementById("title-screen");
        const gameScreen = document.getElementById("game-screen");
        const resultScreen = document.getElementById("result-screen");
        const teacherSprite = document.getElementById("teacher-sprite");
        const studentSprite = document.getElementById("student-sprite");
        const scoreEl = document.getElementById("score-board");
        const highScoreEl = document.getElementById("high-score");
        const titleHighScoreEl = document.getElementById("high-score-title");
        const playerArea = document.getElementById("player-area");

        let isSleeping = false;
        let isTeacherLooking = false;
        let score = 0;
        let highScore = localStorage.getItem("katoGamePixelFixHighScore") || 0;
        let gameOver = false;
        let zzzInterval;

        titleHighScoreEl.textContent = "TOP: " + (highScore / 10).toFixed(1);
        highScoreEl.textContent = "HI: " + (highScore / 10).toFixed(1);

        function startGame() {
            titleScreen.classList.add("hidden");
            gameScreen.classList.remove("hidden");
            updateTeacher();
            gameLoop();
        }

        // 先生の動き管理
        function updateTeacher() {
            if (gameOver) return;
            
            // デフォルト：書いている
            setTeacherState("writing");

            let difficulty = Math.max(800, 4000 - (score * 5)); 
            let waitTime = Math.random() * difficulty + 1000;

            setTimeout(() => {
                // チラ見
                setTeacherState("peeking");

                setTimeout(() => {
                    // 振り返る（怒り）
                    setTeacherState("angry");
                    isTeacherLooking = true;

                    setTimeout(() => {
                        if(!gameOver) {
                            isTeacherLooking = false;
                            updateTeacher();
                        }
                    }, Math.random() * 1500 + 500);

                }, 800); 

            }, waitTime);
        }

        function setTeacherState(state) {
            // クラスを全部消して、新しい状態だけつける
            teacherSprite.className = "sprite teacher-" + state;
        }

        function gameLoop() {
            setInterval(() => {
                if (gameOver) return;
                if (isSleeping) {
                    score++;
                    scoreEl.textContent = "SCORE: " + (score / 10).toFixed(1);
                    if (isTeacherLooking) endGame();
                }
            }, 100);
        }

        function spawnZzz() {
            const zzz = document.createElement("div");
            zzz.className = "zzz";
            zzz.textContent = "z";
            zzz.style.left = "50%"; 
            zzz.style.top = "0px";
            playerArea.appendChild(zzz);
            setTimeout(() => zzz.remove(), 1500);
        }

        function endGame() {
            gameOver = true;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem("katoGamePixelFixHighScore", highScore);
            }
            studentSprite.className = "sprite student-busted";
            
            setTimeout(() => {
                gameScreen.classList.add("hidden");
                resultScreen.classList.remove("hidden");
                document.getElementById("final-score").textContent = "SCORE: " + (score / 10).toFixed(1);
            }, 1000);
        }

        const startSleep = () => {
            if (!gameOver) {
                isSleeping = true;
                studentSprite.className = "sprite student-sleeping";
                if (!zzzInterval) zzzInterval = setInterval(spawnZzz, 400);
            }
        };

        const stopSleep = () => {
            if (!gameOver) {
                isSleeping = false;
                studentSprite.className = "sprite student-awake";
                if (zzzInterval) {
                    clearInterval(zzzInterval);
                    zzzInterval = null;
                }
            }
        };

        const touchLayer = document.getElementById("player-area");
        touchLayer.addEventListener("touchstart", (e) => { e.preventDefault(); startSleep(); });
        touchLayer.addEventListener("touchend", (e) => { e.preventDefault(); stopSleep(); });
        document.addEventListener("keydown", (e) => { if (e.code === "Space") startSleep(); });
        document.addEventListener("keyup", (e) => { if (e.code === "Space") stopSleep(); });

    </script>
</body>
</html>